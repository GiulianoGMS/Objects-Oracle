CREATE OR REPLACE PROCEDURE NAGP_EXCLUI_NF_CANCELADA_SEFAZ AS
   -- Criado por Giuliano em 05/01/2024
   -- Exclui notas canecladas pela Sefaz que estÃ£o na Primeira e Segunda Tela
      psSeqAuxNF NUMBER;
      
  BEGIN
        FOR t IN (SELECT A.CHAVEACESSO, SEQNOTAFISCAL, INSTR(SEQNOTAFISCAL,1) SEQUENCIAL,
                 (SELECT SEQAUXNOTAFISCAL FROM MLF_AUXNOTAFISCAL AUX WHERE AUX.NFECHAVEACESSO = A.CHAVEACESSO) SeqAuxNotaFiscal
                    FROM MRLV_NFEIMPORTACAO A INNER JOIN MRL_NFEIMPORT_CANCREJ B ON A.CHAVEACESSO = B.NFECHAVEACESSO
                                               LEFT JOIN TMP_M000_NF I           ON I.M000_NR_CHAVE_ACESSO = A.CHAVEACESSO
                   WHERE 1=1
                     AND B.INDCANCELREJEICAO = 'C'
                     AND I.M000_DT_EMISSAO > SYSDATE - 20)
          
  LOOP
   BEGIN
     
   -- Pega o SeqAUxNotaFiscal para deletar da Segunda Tela, caso esteja na segunda
   
   psSeqAuxNF := T.SEQAUXNOTAFISCAL;
   
   IF psSeqAuxNF IS NOT NULL 
     THEN
          
   -- Caso a NF esteja na segunda tela, deleta e retorna para a primeira
    
    DELETE FROM MLF_AUXNFITEM              WHERE SEQAUXNOTAFISCAL = psSeqAuxNF;
    DELETE FROM MLF_AUXNFVENCIMENTO        WHERE SEQAUXNOTAFISCAL = psSeqAuxNF;
    DELETE FROM MLF_AUXNFVENCIMENTOCONSIST WHERE SEQAUXNOTAFISCAL = psSeqAuxNF;
    DELETE FROM MLF_AUXNFINCONSISTENCIA    WHERE SEQAUXNOTAFISCAL = psSeqAuxNF;
    DELETE FROM MLF_NFITEMLOTE             WHERE SEQAUXNOTAFISCAL = psSeqAuxNF;
    DELETE FROM MLF_CONHECIMENTONOTAS      WHERE SEQAUXNOTAFISCAL = psSeqAuxNF;
    DELETE FROM MLF_SERVICONOTAS           WHERE SEQAUXNOTAFISCAL = psSeqAuxNF;
    DELETE FROM MLF_GNRE                   WHERE SEQAUXNOTAFISCAL = psSeqAuxNF;
    DELETE FROM MLF_AUXNFVENCTITDIREITO    WHERE SEQAUXNOTAFISCAL = psSeqAuxNF;
    DELETE FROM MLF_AUXNOTAFISCAL          WHERE SEQAUXNOTAFISCAL = psSeqAuxNF;
    COMMIT;
    
   -- Deleta da Primeira Tela
   
   END IF;
      
    INSERT INTO CONSINCO.MLF_NFE_EXCLUIDA VALUES (T.CHAVEACESSO, T.SEQUENCIAL, SYSDATE, 'AUTOMATICO');
    COMMIT;
    
    BEGIN 
     PKG_MLF_IMPNFERECEBIMENTO.SP_EXCLUI_TMP(T.SEQNOTAFISCAL); 
    END;
    
   END;
  END LOOP;
 COMMIT;
END;
