CREATE OR REPLACE VIEW CONSINCO.NAGV_PROD_RELACIONADOS_ITWORKS AS

-- Criado por Giuliano em 26/01/24
-- Ticket 333702 -- Alterado em solic. Ticket 348367

SELECT DISTINCT LPAD(P.SEQPRODUTO,6,0) PRODUTO,     P.DESCCOMPLETA DESC_PROD,
       DECODE(CP.FINALIDADEFAMILIA,'R','00','P','01','A','08','U','07','P','01','D','99','S','09','F','09','H','99','E','02','B','99','O','07','M','99') TIPOITEM_PROD,

      (SELECT DECODE(X.STATUSCOMPRA,'A','ATIVO','I','INATIVO', 'S', 'SUSPENSO') FROM MRL_PRODUTOEMPRESA X WHERE X.NROEMPRESA = 8 AND X.SEQPRODUTO = P.SEQPRODUTO) COMPRA,
      (SELECT DECODE(NVL(FF.STATUSVENDA,'A'),'A','ATIVO','I','INATIVO')          FROM MRL_PRODEMPSEG FF     WHERE FF.NROEMPRESA = 8 AND FF.SEQPRODUTO = P.SEQPRODUTO AND FF.NROSEGMENTO = 2 AND FF.QTDEMBALAGEM = 1) VENDA,

       LPAD(P.SEQPRODUTO,6,0) PRODUTO_ATOMICO, P.DESCCOMPLETA DESC_ATOMICO,
       DECODE(CP.FINALIDADEFAMILIA,'R','00','P','01','A','08','U','07','P','01','D','99','S','09','F','09','H','99','E','02','B','99','O','07','M','99') TIPOITEM_ATOMICO,

      (SELECT Y.EMBALAGEM FROM MAP_FAMEMBALAGEM Y
         WHERE Y.SEQFAMILIA = P.SEQFAMILIA
           AND Y.QTDEMBALAGEM = PC.QTDEMBALAGEM) UNIDADEESTOQUE,
      (SELECT Y.EMBALAGEM FROM MAP_FAMEMBALAGEM Y
         WHERE Y.SEQFAMILIA = P.SEQFAMILIA
           AND Y.QTDEMBALAGEM = PC.QTDEMBALAGEM) UNIDADECOMERCIAL,

       1 QUANTIDADE,
       P.DTAHORINCLUSAO,
       P.DTAHORALTERACAO DTAHORALTERACAO

  FROM CONSINCO.MAP_PRODUTO P INNER JOIN CONSINCO.MAP_PRODUTO F ON P.SEQPRODUTO = F.SEQPRODUTOBASE
                     INNER JOIN CONSINCO.MAP_FAMDIVISAO CP ON CP.SEQFAMILIA = P.SEQFAMILIA
                     INNER JOIN CONSINCO.MAP_FAMDIVISAO CF ON CF.SEQFAMILIA = F.SEQFAMILIA
                     INNER JOIN CONSINCO.MAP_PRODCODIGO PC ON PC.SEQPRODUTO = F.SEQPRODUTO

 WHERE 1=1
   AND CF.FINALIDADEFAMILIA = 'R'
   /*AND (NVL((SELECT MAX(DTAHORAUDITORIA) FROM MAP_AUDITORIA MF WHERE MF.SEQIDENTIFICA = F.SEQPRODUTO
                                                           AND MF.TABELA = 'MAP_PRODUTO'
                                                           AND MF.CAMPO  = 'SEQPRODUTOBASE'), F.DTAHORALTERACAO) >= SYSDATE - 30 OR P.DTAHORINCLUSAO > SYSDATE - 30)*/

UNION ALL

SELECT "PRODUTO","DESC_PROD","TIPOITEM_PAI","COMPRA","VENDA","PRODUTO_ATOMICO","DESC_ATOMICO","TIPOITEM_FILHO","UNIDADEESTOQUE","UNIDADECOMERCIAL","QUANTIDADE","DTAHORINCLUSAO","DTAHORALTERACAO" FROM (
SELECT DISTINCT LPAD(F.SEQPRODUTO,6,0) PRODUTO,     F.DESCCOMPLETA DESC_PROD,
       DECODE(CF.FINALIDADEFAMILIA,'R','00','P','01','A','08','U','07','P','01','D','99','S','09','F','09','H','99','E','02','B','99','O','07','M','99') TIPOITEM_PAI,

      (SELECT DECODE(X.STATUSCOMPRA,'A','ATIVO','I','INATIVO', 'S', 'SUSPENSO') FROM MRL_PRODUTOEMPRESA X WHERE X.NROEMPRESA = 8 AND X.SEQPRODUTO = P.SEQPRODUTO) COMPRA,
      (SELECT DECODE(NVL(F.STATUSVENDA,'A'),'A','ATIVO','I','INATIVO')          FROM MRL_PRODEMPSEG F     WHERE F.NROEMPRESA = 8 AND F.SEQPRODUTO = P.SEQPRODUTO AND F.NROSEGMENTO = 2 AND F.QTDEMBALAGEM = 1) VENDA,

       LPAD(P.SEQPRODUTO,6,0) PRODUTO_ATOMICO, P.DESCCOMPLETA DESC_ATOMICO,
       DECODE(CF.FINALIDADEFAMILIA,'R','00','P','01','A','08','U','07','P','01','D','99','S','09','F','09','H','99','E','02','B','99','O','07','M','99') TIPOITEM_FILHO,

      (SELECT Y.EMBALAGEM FROM MAP_FAMEMBALAGEM Y
         WHERE Y.SEQFAMILIA = P.SEQFAMILIA
           AND Y.QTDEMBALAGEM = PC.QTDEMBALAGEM) UNIDADEESTOQUE,
      (SELECT Y.EMBALAGEM FROM MAP_FAMEMBALAGEM Y
         WHERE Y.SEQFAMILIA = P.SEQFAMILIA
           AND Y.QTDEMBALAGEM = PC.QTDEMBALAGEM) UNIDADECOMERCIAL,

       1 QUANTIDADE,
       F.DTAHORINCLUSAO,
       GREATEST((SELECT MAX(DTAHORAUDITORIA) FROM MAP_AUDITORIA MF WHERE MF.SEQIDENTIFICA = F.SEQPRODUTO
                                                           AND MF.TABELA = 'MAP_PRODUTO'
                                                           AND MF.CAMPO  = 'SEQPRODUTOBASE'), F.DTAHORALTERACAO) DTAHORALTERACAO

  FROM CONSINCO.MAP_PRODUTO P INNER JOIN CONSINCO.MAP_PRODUTO F ON P.SEQPRODUTO = F.SEQPRODUTOBASE
                     INNER JOIN CONSINCO.MAP_FAMDIVISAO CP ON CP.SEQFAMILIA = P.SEQFAMILIA
                     INNER JOIN CONSINCO.MAP_FAMDIVISAO CF ON CF.SEQFAMILIA = F.SEQFAMILIA
                     INNER JOIN CONSINCO.MAP_PRODCODIGO PC ON PC.SEQPRODUTO = F.SEQPRODUTO

 WHERE 1=1
   AND CF.FINALIDADEFAMILIA = 'R'
   /*AND (NVL((SELECT MAX(DTAHORAUDITORIA) FROM MAP_AUDITORIA MF WHERE MF.SEQIDENTIFICA = F.SEQPRODUTO
                                                           AND MF.TABELA = 'MAP_PRODUTO'
                                                           AND MF.CAMPO  = 'SEQPRODUTOBASE'), F.DTAHORALTERACAO) >= SYSDATE - 30 OR P.DTAHORINCLUSAO > SYSDATE - 30)*/
 ORDER BY LPAD(P.SEQPRODUTO,6,0), LPAD(F.SEQPRODUTO,6,0));
 
 
