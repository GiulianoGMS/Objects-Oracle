ALTER SESSION SET CURRENT_SCHEMA = CONSINCO;

CREATE OR REPLACE VIEW CONSINCO.NAGV_PROD_RELACIONADOS_ITWORKS AS
--Ticket 333702
SELECT DISTINCT P.SEQPRODUTO PRODUTO_PAI,     P.DESCCOMPLETA DESC_PAI,   
       DECODE(CP.FINALIDADEFAMILIA,'R','00','P','01','A','08','U','07','P','01','D','99','S','09','F','09','H','99','E','02','B','99','O','07','M','99') TIPOITEM_PAI,    
       
      (SELECT DECODE(X.STATUSCOMPRA,'A','ATIVO','I','INATIVO', 'S', 'SUSPENSO') FROM MRL_PRODUTOEMPRESA X WHERE X.NROEMPRESA = 8 AND X.SEQPRODUTO = P.SEQPRODUTO) COMPRA,
      (SELECT DECODE(NVL(F.STATUSVENDA,'A'),'A','ATIVO','I','INATIVO')          FROM MRL_PRODEMPSEG F     WHERE F.NROEMPRESA = 8 AND F.SEQPRODUTO = P.SEQPRODUTO AND F.NROSEGMENTO = 2 AND F.QTDEMBALAGEM = 1) VENDA,
      
       F.SEQPRODUTO PRODUTO_ATOMICO, F.DESCCOMPLETA DESC_FILHO, 
       DECODE(CF.FINALIDADEFAMILIA,'R','00','P','01','A','08','U','07','P','01','D','99','S','09','F','09','H','99','E','02','B','99','O','07','M','99') TIPOITEM_FILHO, 
       
      (SELECT Y.EMBALAGEM FROM MAP_FAMEMBALAGEM Y
         WHERE Y.SEQFAMILIA = F.SEQFAMILIA
           AND Y.QTDEMBALAGEM = PC.QTDEMBALAGEM) UNIDADEESTOQUE,
      (SELECT Y.EMBALAGEM FROM MAP_FAMEMBALAGEM Y
         WHERE Y.SEQFAMILIA = F.SEQFAMILIA
           AND Y.QTDEMBALAGEM = PC.QTDEMBALAGEM) UNIDADECOMERCIAL,
           
       1 QUANTIDADE, 
       F.DTAHORINCLUSAO,
       NVL((SELECT MAX(DTAHORAUDITORIA) FROM MAP_AUDITORIA MF WHERE MF.SEQIDENTIFICA = F.SEQPRODUTO
                                                           AND MF.TABELA = 'MAP_PRODUTO'
                                                           AND MF.CAMPO  = 'SEQPRODUTOBASE'), F.DTAHORALTERACAO) DTAHORALTERACAO
       
  FROM CONSINCO.MAP_PRODUTO P INNER JOIN CONSINCO.MAP_PRODUTO F ON P.SEQPRODUTO = F.SEQPRODUTOBASE 
                     INNER JOIN CONSINCO.MAP_FAMDIVISAO CP ON CP.SEQFAMILIA = P.SEQFAMILIA
                     INNER JOIN CONSINCO.MAP_FAMDIVISAO CF ON CF.SEQFAMILIA = F.SEQFAMILIA
                     INNER JOIN CONSINCO.MAP_PRODCODIGO PC ON PC.SEQPRODUTO = F.SEQPRODUTO
                     
 WHERE 1=1  
   /*AND (NVL((SELECT MAX(DTAHORAUDITORIA) FROM MAP_AUDITORIA MF WHERE MF.SEQIDENTIFICA = F.SEQPRODUTO
                                                           AND MF.TABELA = 'MAP_PRODUTO'
                                                           AND MF.CAMPO  = 'SEQPRODUTOBASE'), F.DTAHORALTERACAO) >= SYSDATE - 30 OR P.DTAHORINCLUSAO > SYSDATE - 30)*/
 ORDER BY P.SEQPRODUTO, F.SEQPRODUTO
