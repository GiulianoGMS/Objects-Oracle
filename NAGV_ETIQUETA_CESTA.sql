CREATE OR REPLACE VIEW CONSINCO.NAGV_ETIQUETA_CESTA AS
SELECT /*+OPTIMIZER_FEATURES_ENABLE('11.2.0.4')*/
        -- Novo modelo criado por Giuliano | 29/04/2025
        -- Modelo anterior por Ricardo Santana

       NULL MARCA, BASE."NROEMPRESA",BASE."SEQPRODUTO",BASE."DTABASEPRECO",BASE."CODACESSO",BASE."QTDETIQUETA",BASE."DTAPROMINICIO",
       BASE."DTAPROMFIM",BASE."CODACESSOPADRAO",BASE."EMBALAGEMPADRAO",BASE."PADRAOEMBVENDA",BASE."PRECOEMBPADRAO",BASE.PRECOVALIDNORMAL,BASE.PRECOVALIDPROMOC,BASE."MULTEQPEMBPADRAO",
       BASE."QTDUNIDEMBPADRAO",BASE."TIPOETIQUETA",BASE."TIPOPRECO",BASE."DESCCOMPLETA",BASE."DESCREDUZIDA",BASE."QTDEMBALAGEM1",BASE."MULTEQPEMB1",
       BASE."QTDUNIDEMB1",BASE."QTDEMBALAGEM2",BASE."MULTEQPEMB2",BASE."QTDUNIDEMB2",BASE."QTDEMBALAGEM3",BASE."MULTEQPEMB3",BASE."QTDUNIDEMB3",
       BASE."QTDEMBALAGEM4",BASE."MULTEQPEMB4",BASE."QTDUNIDEMB4",BASE."QTDEMBALAGEM5",BASE."MULTEQPEMB5",BASE."QTDUNIDEMB5",BASE."CODACESSO1",BASE."CODACESSO2",
       BASE."CODACESSO3",BASE."CODACESSO4",BASE."CODACESSO5",BASE."PRECO1",BASE."PRECO2",BASE."PRECO3",BASE."PRECO4",BASE."PRECO5",BASE."PRECOMIN",BASE."PRECOMAX",
       BASE."EMBALAGEM1",BASE."EMBALAGEM2",BASE."EMBALAGEM3",BASE."EMBALAGEM4",BASE."EMBALAGEM5",BASE."TIPOCODIGO", BASE.QTDEMBCODACESSO,
       
        '^XA' || '^PRA^FS' || '^LH00,00^FS'|| '^BY2^FS' || '^PQ' || NVL(BASE.QTDETIQUETA, 1) || '^FS'
        -- Imagem
      ||'^FO625,670^GFA,2057,2057,17,,::Q01JFC,P01LFC,P07MF8,O07OF,N03PFE,N0RFC,M03SF,M0TF8,L03TFE,L0VF8,K01VFC,K03VFE,K07WF8,J01XFC,J03XFE,J07YF,J0gF8,I01gFC,I03gFE,I07gGF,I0gHF8,001NFEI03OFC,001NFK07NFE,003MFCL0NFE,007MFM07NF,00MFEM01NF8,00MF8N0NF8,01MFO03MFC,01LFEO01MFE,03LFCP0MFE,03LF8P07MF,07LFQ03MF8,07KFEQ01MF8,0LFCQ01MF8,0LF8R0MFC,1LF8R07LFC,1LFS03LFE,3KFES03LFE,:3KFCS01MF,7KFCL0FL01MF,7KF8K03FFL0MF8,7KF8K07FF8K0MF8,7KF8J01IFCK07LF8,LF8J03IFEK07LF8,LFK03JFK07LF8,LFK07JF8J07LF8,LFK07JF8J07LFC,LFK0KF8J03LFC,:LFJ01KFCJ03LFC,:::::::::::::::::LFJ01KFCJ03LF8,:::7KFJ01KFCJ03LF8,7KFJ01KFCJ01LF8,7KFJ01KFCK0LF,3KFJ01KFEK07KF,3KFJ01KFEM07FFE,3KFJ01LFM07FFE,1KFJ01LFM07FFE,1KFJ01LF8L07FFC,1KFJ01LF8L0IFC,0KFJ01LFCK01IF8,07JFJ01LFEK03IF8,07JFJ01MF8J07IF,03JFJ01MFCI01JF,03JFCI07NF800KF,01gJFE,01gJFC,00gJF8,:007gIF,003gHFE,001gHFE,001gHFC,I0gHF8,I07gGF,I03gGF,I01gFE,J0gFC,J07YF,J03XFE,J01XFC,K0XF8,K03VFE,K01VFC,L0VF8,L03UF,L01TFC,M07SF,M01RFC,N07QF,O0PF8,O01NFC,Q0LF8,R03IF,,::^FS'
      ||'^PW831
        ^LL720
        ^MMT
        ^LS0'
        
        -- CABEÇALHO
      ||'^CF0,30
        ^FO30,30^FD'||BASE.DESCCOMPLETA||'^FS
        ^FO30,70^GB740,3,3^FS9'

      -- COLUNAS CABECALHO
      ||'^CF0,23^FO50,85^FDProduto^FS
        ^FO700,85^FDQtde^FS
        ^FO30,115^GB740,3,3^FS'

      -- PRODUTOS

        ||(SELECT LISTAGG(LINHA_ZPL, CHR(10)) AS ZPL_OUTPUT
          FROM (
            SELECT 
              -- Texto do produto
              '^CF0,18^FO50,' || (125 + (LINHA - 1) * 25) || '^FD' || COMPONENTE || '^FS' || CHR(10) ||
              -- Quantidade
              '^CF0,18^FO702,' || (125 + (LINHA - 1) * 25) || '^FD' || TO_CHAR(QTDE, 'FM999G990D000', 'NLS_NUMERIC_CHARACTERS = '',.''') || '^FS' ||
              -- Risco (linha horizontal), exceto na última
              CASE 
                WHEN LINHA < TOTAL_LINHAS THEN 
                  CHR(10) || '^FO30,' || (125 + (LINHA - 1) * 25 + 17) || '^GB740,1,1^FS'
                ELSE 
                  ''
              END AS LINHA_ZPL
            FROM (
              SELECT 
                A.PRODUTOCOMP COMPONENTE,
                A.QTDUTILIZADA QTDE,
                ROW_NUMBER() OVER (ORDER BY A.PRODUTOCOMP) AS LINHA,
                COUNT(*) OVER () AS TOTAL_LINHAS
              FROM CONSINCO.MRLV_COMPONENTESRECEITA A
              WHERE A.NROEMPRESA = BASE.NROEMPRESA
                AND A.SEQPRODUTOFINAL = BASE.SEQPRODUTO
            )
          ))||

      -- SEPARADOR
        '^FO30,652^GB740,3,3^FS'
        

        -- DATAS
      ||'^CF0,20
        ^FO38,670^FDFab.: '||TO_CHAR(SYSDATE, 'DD/MM/YYYY')||'^FS
        ^FO200,670^FDValidade:'||TO_CHAR(SYSDATE + 120, 'DD/MM/YYYY')||'^FS
        ^FO400,670^FDCod. Produto: '||BASE.SEQPRODUTO||'^FS'

      -- CÓDIGO DE BARRAS
      ||'^BY3,2,80
        ^FO40,700^BCN,60,Y,N
        ^FD'||C.CODACESSO||'^FS

        ^XZ
        ' LINHA
        
FROM CONSINCO.MRLX_BASEETIQUETAPROD BASE INNER JOIN MAP_PRODCODIGO C ON C.SEQPRODUTO = BASE.SEQPRODUTO AND C.TIPCODIGO = 'B'

ORDER BY LINHA
