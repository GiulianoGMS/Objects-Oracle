CREATE OR REPLACE PROCEDURE CONSINCO.NAGP_EXP_ETIQUETAS_V1 AS


   v_file UTL_FILE.file_type;
   v_output VARCHAR2(4000); 

BEGIN
   
   FOR t IN (SELECT /*+OPTIMIZER_FEATURES_ENABLE('11.2.0.4')*/
                    '^XA' || '^PRA^FS' || '^LH00,00^FS'|| '^BY2^FS' || '^PQ' || '1' || '^FS'|| CHR(13) || CHR(10) ||

                    '^FO050,170^BY2.4^BEN,25,Y,N^FD'||PC.CODACESSO||'^FS'|| CHR(13) || CHR(10) ||
                    '^FO50,20^A0N,40,40^FD'||SUBSTR(P.DESCCOMPLETA,0,40) ||' '||CASE WHEN J.QTDEMBALAGEM > 1 THEN J.EMBALAGEM ELSE NULL END||'^FS' || CHR(13) || CHR(10) ||'^FS'||

                    '^FO50,251^A0N,20,20^FD'||TO_CHAR(SYSDATE, 'DD/MM/YY HH24:MI')||'   Produto: '||P.SEQPRODUTO||'   Val. Prom.: '||TO_CHAR(DTINICIO, 'DD/MM/YY')||' a '||TO_CHAR(DTFIM, 'DD/MM/YY')||' - Loja: '||G.NOMEREDUZIDO||'^FS'||CHR(13) || CHR(10) ||

                    '^FO275,90^A0N,35,35^FDPreco^FS'      || CHR(13) || CHR(10) ||
                    '^FO490,90^A0N,30,30^FD  R$  ^FS'     || CHR(13) || CHR(10) ||
                    '^FO580,73^A0N,58,58^FD'||LPAD(TRUNC(H.PRECOVALIDNORMAL), 4, ' ' ) || ',' || LPAD((H.PRECOVALIDNORMAL - TRUNC(H.PRECOVALIDNORMAL)) * 100, 2, '0')|| '^FS' || CHR(13) || CHR(10) || -- PRECO NORMAL
                     (CASE WHEN J.MULTEQPEMB IS NOT NULL  OR J.MULTEQPEMBALAGEM IS NOT NULL THEN
                    '^FO590,128^A0N,15,15^FDNesta Embalagem '||
                                                   CASE WHEN J.MULTEQPEMBALAGEM = 'LI' THEN 'L' WHEN  J.MULTEQPEMBALAGEM = 'GR' THEN '100g' ELSE J.MULTEQPEMBALAGEM END ||' R$ ' ||
                                                    DECODE(SIGN(J.PRECOGERPROMOC),+1,
                                                    TRANSLATE(TO_CHAR(ROUND((J.PRECOGERPROMOC/(J.MULTEQPEMB*1000))*1000 ,2),'FM9990.00'), '.', ','),
                                                    TRANSLATE(TO_CHAR(ROUND((J.PRECOGERNORMAL/(J.MULTEQPEMB*1000))*1000 ,2),'FM9990.00'), '.', ',')) END )||'^FS' || CHR(13) || CHR(10) ||
                    '^FO690,85^A0N,090,40^FD  ^FS'        || CHR(13) || CHR(10) ||
                    '^FO260,60^GB530,85,1^FS'             || CHR(13) || CHR(10) ||
                    '^FO260,60^GB232,85,1^FS'             || CHR(13) || CHR(10) ||
                    '^FO260,155^GB530,85,1^FS'            || CHR(13) || CHR(10) ||
                    
                    '^FO490,195^A0N,30,30^FD  R$  ^FS'    || CHR(13) || CHR(10) ||
                    '^FO495,175^A0N,20,20^FD  POR  ^FS'   || CHR(13) || CHR(10) ||
                    '^FO275,170^A0N,35,35^FDMeu Nagumo^FS'|| CHR(13) || CHR(10) ||
                    '^FO275,205^A0N,20,20^FDExclusivo ^FS'|| CHR(13) || CHR(10) ||
                    '^FO580,167^A0N,58,58^FD'||LPAD(TRUNC(PRECOPPROMOCIONAL), 4, ' ' ) || ',' || LPAD((PRECOPPROMOCIONAL - TRUNC(PRECOPPROMOCIONAL)) * 100, 2, '0')||'^FR^FS'|| CHR(13) || CHR(10) ||
                    (CASE WHEN J.MULTEQPEMB IS NOT NULL  OR J.MULTEQPEMBALAGEM IS NOT NULL THEN
                    '^FO590,221^A0N,15,15^FDNesta Embalagem '||
                                                    CASE WHEN J.MULTEQPEMBALAGEM = 'LI' THEN 'L' WHEN  J.MULTEQPEMBALAGEM = 'GR' THEN '100g' ELSE J.MULTEQPEMBALAGEM END ||' R$ ' ||
                                                    DECODE(SIGN(PRECOPPROMOCIONAL),+1,
                                                    TRANSLATE(TO_CHAR(ROUND((PRECOPPROMOCIONAL/(J.MULTEQPEMB*1000))*1000 ,2),'FM9990.00'), '.', ','),
                                                    TRANSLATE(TO_CHAR(ROUND((PRECOPPROMOCIONAL/(J.MULTEQPEMB*1000))*1000 ,2),'FM9990.00'), '.', ',')) END)||'^FS'|| CHR(13) || CHR(10) ||

                    '^FO490,155^GB300,85,52^FR^FS'|| CHR(13) || CHR(10) ||
                    -- Logo
                    '^FO045,40,0^GFA,4077,4077,27,'|| CHR(13) || CHR(10) ||',::::::::::::::::::::::::::::::::::::::::::::::::gI0G1GFG8gN0X0G7G8I0G7GFGCgN0W0G3HFI0HFGEgN0W0G7HFG8G0G1HFGEgN0W0IFGEG0G3GFG0GFgN0W0JFG0G7GCG
                    0G7gN0V0G1JFG8GFG8G0G3gN0V0G1GFGCG1GFGDGFH0G3gN0V0G1GFG8G0G7GFGEH0G3gN0V0G1GFH0G3GFGCH0G3gN0V0G1GEI0GFGCH0G3G0GFG8G0G6gI0V0G1GEI0G7G8H0H3GFGCG0GEG0G7gG0V0G1GEI0G7I0G3G7GCG4G1GEG0GFgG0V0G1GEI0G2I0G2G
                    FG8G4G1GCG1GEgG0V0G1GEM0G3GFG0G4G3G8G1GEgG0W0GEM0G7GEG0G8G3G8G3GCgG0W0GEM0G7GCG0G8G7G0G7G8gG0W0GFM0G7G8G3G0GFG0GFG0G4g0W0G7M0G7G8G6G1GEG0GFG0G8g0W0G7M0GFG1G8G3GEG1GEG0G8g0W0G3G8L0GFGCG0G6GEG2GEG1gG0
                    W0G1GCL0G7H0HCG4GCG2gG0X0GCL0G7G0G1G0GCG8GCG4gG0X0G6L0G3G8G6G0GFG0GCG8gG0X0G3L0G1GFJ0G6gH0X0G1G8gT0,:::R0G4H0G6H0G6I0G3GEH0GCH0GCG0GCH0GCH0G7GEU0R0GFH0GFH0GFG8H0HFGCG1GEG0G1GEG1GEG0G1GEG0G1HFG8T0R0G
                    FG8G0GFG0G1GFGCG0G3HFGEG3GEG0G1GEG1GFG0G1GEG0G3HFGCT0R0GFGCG0GFG0G3GFGCG0G7HFGEG3GEG0G1GEG3GFG0G3GFG0G7HFGET0R0GFGEG0GFG0G3GFGEG0G7HFGEG3GEG0G1GEG3GFG0G3GFG0JFT0R0GFGEG0GFG0G3GFGEG0GFGCG1GEG3GEG0G1G
                    EG3GFG8G7GFG0GFGCG3GFG8S0R0HFG0GFG0G7GFGEG0GFG8H0G3GEG0G1GEG3GFG8G7GFG1GFG8G0GFG8S0R0HFG8GFG0G7GDGFG1GFI0G3GEG0G1GEG3GFGCHFG1GFH0GFGCS0R0HFGCGFG0G7GDGFG1GFG0G7GFG3GEG0G1GEG3GFGCHFG1GEH0G7GCS0R0JFG0G
                    FG8GFG9GFG0HFGBGEG0G1GEG7GFGCHFG9GEH0G7GCS0R0GFG7HFG0GFG8GFG9GFG0HFGBGEG0G1GEG7JFG9GEH0G7GCS0R0GFG3HFG0GFG8GFG9GFG0HFGBGEG0G3GEG7JFG9GFH0G7GCS0R0GFG1HFG1IFGDGFG8G7GFG9GFG0G3GEG7GDGFGEGFG9GFH0GFG8S0R
                    0GFG0HFG1IFGCGFGCG0GFG9GFG0G7GEG7G9GFGEG7G9GFG8G1GFG8S0R0GFG0G7GFG3IFGCGFGEG3GFG9GFGCGFGCGFG9GFGEG7GCGFGEG7GFG8S0R0GFG0G3GFG3IFGEG7IFG0IFGCGFG8GFGCG7GCJFT0R0GFG0G1GFG3GEG0G3GEG3IFG0G7HFG8GFG8GFGCG7G
                    CG7HFGET0R0GFG0G1GFG3GCG0G3GEG1HFGCG0G3HFG0GFG8G7G8G7GCG3HFGCT0R0GFH0GFG3GCG0G1GCG0G7GFG8G0G1GFGEG0G7G0G7G8G3G8G0HFU0,::::::::::::::::::::::::::::::::::::::::::::::::::::^FS'
                    --FIM DA ETIQUETA
                    || CHR(13) || CHR(10) || '^XZ'
                    || CHR(13) || CHR(10) LINHA, P.SEQPRODUTO

                    FROM REMARCAPROMOCOES@INFOPROCMSSQL X INNER JOIN CONSINCO.MAP_PRODCODIGO PC           ON LPAD(PC.CODACESSO,14,0) = X.CODIGOPRODUTO AND TIPCODIGO = 'E'
                                                          INNER JOIN CONSINCO.MRL_PRODEMPSEG H            ON H.SEQPRODUTO = PC.SEQPRODUTO AND H.NROEMPRESA = X.CODLOJA AND H.NROSEGMENTO = 2 AND H.QTDEMBALAGEM = 1
                                                          INNER JOIN CONSINCO.MRLV_BASEETIQUETAPROD_NAG J ON J.NROEMPRESA = X.CODLOJA AND J.SEQPRODUTO = PC.SEQPRODUTO AND J.NROSEGMENTO = 2 AND J.QTDEMBALAGEM = 1
                                                          INNER JOIN CONSINCO.MAX_EMPRESA G               ON G.NROEMPRESA = J.NROEMPRESA
                                                          INNER JOIN CONSINCO.MAP_PRODUTO P               ON P.SEQPRODUTO = PC.SEQPRODUTO
                     WHERE 1=1 
                       AND CODLOJA = 23
                       AND SYSDATE BETWEEN DTINICIO AND DTFIM
                       AND X.TIPODESCONTO  = 4
                       AND X.PROMOCAOLIVRE = 0
                       AND NVL(H.PRECOVALIDPROMOC,0) = 0) 
   LOOP        
       v_file   := UTL_FILE.fopen('/u02/app_acfs/arquivos/importacao', 'Prod_'||t.SEQPRODUTO||'.txt', 'w');
       v_output := t.LINHA;

       UTL_FILE.put_line(v_file, v_output);
       -- Fecha o arquivo
       UTL_FILE.fclose(v_file);
       
   END LOOP;
   
EXCEPTION
  WHEN OTHERS THEN

      DBMS_OUTPUT.put_line('Erro: ' || SQLERRM);
      IF UTL_FILE.is_open(v_file) THEN
         UTL_FILE.fclose(v_file);
      END IF;
      
END;
CREATE OR REPLACE PROCEDURE CONSINCO.NAGP_EXP_ETIQUETAS_V1 AS


   v_file UTL_FILE.file_type;
   v_output VARCHAR2(4000); 

BEGIN
   
   FOR t IN (SELECT /*+OPTIMIZER_FEATURES_ENABLE('11.2.0.4')*/
                    '^XA' || '^PRA^FS' || '^LH00,00^FS'|| '^BY2^FS' || '^PQ' || '1' || '^FS'|| CHR(13) || CHR(10) ||

                    '^FO050,170^BY2.4^BEN,25,Y,N^FD'||PC.CODACESSO||'^FS'|| CHR(13) || CHR(10) ||
                    '^FO50,20^A0N,40,40^FD'||SUBSTR(P.DESCCOMPLETA,0,40) ||' '||CASE WHEN J.QTDEMBALAGEM > 1 THEN J.EMBALAGEM ELSE NULL END||'^FS' || CHR(13) || CHR(10) ||'^FS'||

                    '^FO50,251^A0N,20,20^FD'||TO_CHAR(SYSDATE, 'DD/MM/YY HH24:MI')||'   Produto: '||P.SEQPRODUTO||'   Val. Prom.: '||TO_CHAR(DTINICIO, 'DD/MM/YY')||' a '||TO_CHAR(DTFIM, 'DD/MM/YY')||' - Loja: '||G.NOMEREDUZIDO||'^FS'||CHR(13) || CHR(10) ||

                    '^FO275,90^A0N,35,35^FDPreco^FS'      || CHR(13) || CHR(10) ||
                    '^FO490,90^A0N,30,30^FD  R$  ^FS'     || CHR(13) || CHR(10) ||
                    '^FO580,73^A0N,58,58^FD'||LPAD(TRUNC(H.PRECOVALIDNORMAL), 4, ' ' ) || ',' || LPAD((H.PRECOVALIDNORMAL - TRUNC(H.PRECOVALIDNORMAL)) * 100, 2, '0')|| '^FS' || CHR(13) || CHR(10) || -- PRECO NORMAL
                     (CASE WHEN J.MULTEQPEMB IS NOT NULL  OR J.MULTEQPEMBALAGEM IS NOT NULL THEN
                    '^FO590,128^A0N,15,15^FDNesta Embalagem '||
                                                   CASE WHEN J.MULTEQPEMBALAGEM = 'LI' THEN 'L' WHEN  J.MULTEQPEMBALAGEM = 'GR' THEN '100g' ELSE J.MULTEQPEMBALAGEM END ||' R$ ' ||
                                                    DECODE(SIGN(J.PRECOGERPROMOC),+1,
                                                    TRANSLATE(TO_CHAR(ROUND((J.PRECOGERPROMOC/(J.MULTEQPEMB*1000))*1000 ,2),'FM9990.00'), '.', ','),
                                                    TRANSLATE(TO_CHAR(ROUND((J.PRECOGERNORMAL/(J.MULTEQPEMB*1000))*1000 ,2),'FM9990.00'), '.', ',')) END )||'^FS' || CHR(13) || CHR(10) ||
                    '^FO690,85^A0N,090,40^FD  ^FS'        || CHR(13) || CHR(10) ||
                    '^FO260,60^GB530,85,1^FS'             || CHR(13) || CHR(10) ||
                    '^FO260,60^GB232,85,1^FS'             || CHR(13) || CHR(10) ||
                    '^FO260,155^GB530,85,1^FS'            || CHR(13) || CHR(10) ||
                    
                    '^FO490,195^A0N,30,30^FD  R$  ^FS'    || CHR(13) || CHR(10) ||
                    '^FO495,175^A0N,20,20^FD  POR  ^FS'   || CHR(13) || CHR(10) ||
                    '^FO275,170^A0N,35,35^FDMeu Nagumo^FS'|| CHR(13) || CHR(10) ||
                    '^FO275,205^A0N,20,20^FDExclusivo ^FS'|| CHR(13) || CHR(10) ||
                    '^FO580,167^A0N,58,58^FD'||LPAD(TRUNC(PRECOPPROMOCIONAL), 4, ' ' ) || ',' || LPAD((PRECOPPROMOCIONAL - TRUNC(PRECOPPROMOCIONAL)) * 100, 2, '0')||'^FR^FS'|| CHR(13) || CHR(10) ||
                    (CASE WHEN J.MULTEQPEMB IS NOT NULL  OR J.MULTEQPEMBALAGEM IS NOT NULL THEN
                    '^FO590,221^A0N,15,15^FDNesta Embalagem '||
                                                    CASE WHEN J.MULTEQPEMBALAGEM = 'LI' THEN 'L' WHEN  J.MULTEQPEMBALAGEM = 'GR' THEN '100g' ELSE J.MULTEQPEMBALAGEM END ||' R$ ' ||
                                                    DECODE(SIGN(PRECOPPROMOCIONAL),+1,
                                                    TRANSLATE(TO_CHAR(ROUND((PRECOPPROMOCIONAL/(J.MULTEQPEMB*1000))*1000 ,2),'FM9990.00'), '.', ','),
                                                    TRANSLATE(TO_CHAR(ROUND((PRECOPPROMOCIONAL/(J.MULTEQPEMB*1000))*1000 ,2),'FM9990.00'), '.', ',')) END)||'^FS'|| CHR(13) || CHR(10) ||

                    '^FO490,155^GB300,85,52^FR^FS'|| CHR(13) || CHR(10) ||
                    -- Logo
                    '^FO045,40,0^GFA,4077,4077,27,'|| CHR(13) || CHR(10) ||',::::::::::::::::::::::::::::::::::::::::::::::::gI0G1GFG8gN0X0G7G8I0G7GFGCgN0W0G3HFI0HFGEgN0W0G7HFG8G0G1HFGEgN0W0IFGEG0G3GFG0GFgN0W0JFG0G7GCG
                    0G7gN0V0G1JFG8GFG8G0G3gN0V0G1GFGCG1GFGDGFH0G3gN0V0G1GFG8G0G7GFGEH0G3gN0V0G1GFH0G3GFGCH0G3gN0V0G1GEI0GFGCH0G3G0GFG8G0G6gI0V0G1GEI0G7G8H0H3GFGCG0GEG0G7gG0V0G1GEI0G7I0G3G7GCG4G1GEG0GFgG0V0G1GEI0G2I0G2G
                    FG8G4G1GCG1GEgG0V0G1GEM0G3GFG0G4G3G8G1GEgG0W0GEM0G7GEG0G8G3G8G3GCgG0W0GEM0G7GCG0G8G7G0G7G8gG0W0GFM0G7G8G3G0GFG0GFG0G4g0W0G7M0G7G8G6G1GEG0GFG0G8g0W0G7M0GFG1G8G3GEG1GEG0G8g0W0G3G8L0GFGCG0G6GEG2GEG1gG0
                    W0G1GCL0G7H0HCG4GCG2gG0X0GCL0G7G0G1G0GCG8GCG4gG0X0G6L0G3G8G6G0GFG0GCG8gG0X0G3L0G1GFJ0G6gH0X0G1G8gT0,:::R0G4H0G6H0G6I0G3GEH0GCH0GCG0GCH0GCH0G7GEU0R0GFH0GFH0GFG8H0HFGCG1GEG0G1GEG1GEG0G1GEG0G1HFG8T0R0G
                    FG8G0GFG0G1GFGCG0G3HFGEG3GEG0G1GEG1GFG0G1GEG0G3HFGCT0R0GFGCG0GFG0G3GFGCG0G7HFGEG3GEG0G1GEG3GFG0G3GFG0G7HFGET0R0GFGEG0GFG0G3GFGEG0G7HFGEG3GEG0G1GEG3GFG0G3GFG0JFT0R0GFGEG0GFG0G3GFGEG0GFGCG1GEG3GEG0G1G
                    EG3GFG8G7GFG0GFGCG3GFG8S0R0HFG0GFG0G7GFGEG0GFG8H0G3GEG0G1GEG3GFG8G7GFG1GFG8G0GFG8S0R0HFG8GFG0G7GDGFG1GFI0G3GEG0G1GEG3GFGCHFG1GFH0GFGCS0R0HFGCGFG0G7GDGFG1GFG0G7GFG3GEG0G1GEG3GFGCHFG1GEH0G7GCS0R0JFG0G
                    FG8GFG9GFG0HFGBGEG0G1GEG7GFGCHFG9GEH0G7GCS0R0GFG7HFG0GFG8GFG9GFG0HFGBGEG0G1GEG7JFG9GEH0G7GCS0R0GFG3HFG0GFG8GFG9GFG0HFGBGEG0G3GEG7JFG9GFH0G7GCS0R0GFG1HFG1IFGDGFG8G7GFG9GFG0G3GEG7GDGFGEGFG9GFH0GFG8S0R
                    0GFG0HFG1IFGCGFGCG0GFG9GFG0G7GEG7G9GFGEG7G9GFG8G1GFG8S0R0GFG0G7GFG3IFGCGFGEG3GFG9GFGCGFGCGFG9GFGEG7GCGFGEG7GFG8S0R0GFG0G3GFG3IFGEG7IFG0IFGCGFG8GFGCG7GCJFT0R0GFG0G1GFG3GEG0G3GEG3IFG0G7HFG8GFG8GFGCG7G
                    CG7HFGET0R0GFG0G1GFG3GCG0G3GEG1HFGCG0G3HFG0GFG8G7G8G7GCG3HFGCT0R0GFH0GFG3GCG0G1GCG0G7GFG8G0G1GFGEG0G7G0G7G8G3G8G0HFU0,::::::::::::::::::::::::::::::::::::::::::::::::::::^FS'
                    --FIM DA ETIQUETA
                    || CHR(13) || CHR(10) || '^XZ'
                    || CHR(13) || CHR(10) LINHA, P.SEQPRODUTO

                    FROM REMARCAPROMOCOES@INFOPROCMSSQL X INNER JOIN CONSINCO.MAP_PRODCODIGO PC           ON LPAD(PC.CODACESSO,14,0) = X.CODIGOPRODUTO AND TIPCODIGO = 'E'
                                                          INNER JOIN CONSINCO.MRL_PRODEMPSEG H            ON H.SEQPRODUTO = PC.SEQPRODUTO AND H.NROEMPRESA = X.CODLOJA AND H.NROSEGMENTO = 2 AND H.QTDEMBALAGEM = 1
                                                          INNER JOIN CONSINCO.MRLV_BASEETIQUETAPROD_NAG J ON J.NROEMPRESA = X.CODLOJA AND J.SEQPRODUTO = PC.SEQPRODUTO AND J.NROSEGMENTO = 2 AND J.QTDEMBALAGEM = 1
                                                          INNER JOIN CONSINCO.MAX_EMPRESA G               ON G.NROEMPRESA = J.NROEMPRESA
                                                          INNER JOIN CONSINCO.MAP_PRODUTO P               ON P.SEQPRODUTO = PC.SEQPRODUTO
                     WHERE 1=1 
                       AND CODLOJA = 23
                       AND SYSDATE BETWEEN DTINICIO AND DTFIM
                       AND X.TIPODESCONTO  = 4
                       AND X.PROMOCAOLIVRE = 0
                       AND NVL(H.PRECOVALIDPROMOC,0) = 0) 
   LOOP        
       v_file   := UTL_FILE.fopen('/u02/app_acfs/arquivos/importacao', 'Prod_'||t.SEQPRODUTO||'.txt', 'w');
       v_output := t.LINHA;

       UTL_FILE.put_line(v_file, v_output);
       -- Fecha o arquivo
       UTL_FILE.fclose(v_file);
       
   END LOOP;
   
EXCEPTION
  WHEN OTHERS THEN

      DBMS_OUTPUT.put_line('Erro: ' || SQLERRM);
      IF UTL_FILE.is_open(v_file) THEN
         UTL_FILE.fclose(v_file);
      END IF;
      
END;
