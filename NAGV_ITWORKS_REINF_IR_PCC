-- View na CONSINCO

SELECT X.NROEMPRESA,
       X.CNPJ_EMP,
       X.DTAEMISSAO,
       X.DTAENTRADA,
       X.DTAVENCIMENTO,
       X.NRONOTA,
       X.NOMERAZAO,
       X.COD_NAT_REND,
       X.VALOR_NF_COMISSAO,
       X.VALOR_PARC,
       X.IRRF,
       X.ALIQIR,
       X.VENC_IRRF,
       X.CODIGO_IR,
       X.VLRPIS,
       X.ALIQPIS,
       X.VLRCOFINS,
       X.ALIQCOFINS,
       X.VLRCSSLL,
       X.ALIQCSSLL,
       X.TOTAL_PCC,
       X.VENC_PCC,
       X.COD_PCC FROM NAGV_ITWORKS_REINF_IR_PCC X

 WHERE TO_DATE(DTAENTRADA, 'DD/MM/YYYY') BETWEEN :DT1 AND :DT2 
   AND LPAD(NROEMPRESA,3,0) IN (#LS1) 
   AND LPAD(NROEMPRESA,3,0) IN (SELECT NROEMPRESA FROM CONSINCO.GE_EMPRESA X WHERE X.MATRIZ IN (#LS2))
   
ORDER BY 1,4

--

-- No Banco

CREATE OR REPLACE VIEW CONSINCO.NAGV_ITWORKS_REINF_IR_PCC AS
SELECT /*Para view por Vencto Sem Crtao - Criada por Giuliano  em 28/09/2023 - Solic Aamalia */
       /*REINF R4020 IR e PCC Sobre Notas - Chamado 268634 - Amalia Petronilio | Criado por Giuliano em 04/08/2023*/
       /*Solicitado separacao de IR e PCC por Amalia - 11/09/2023 - PCC sera retornado no segundo select*/
       
       X.NROEMPRESA, (SELECT LPAD(MA.NROCGC,12,0)||LPAD(MA.DIGCGC,2,0) FROM CONSINCO.MAX_EMPRESA MA WHERE MA.NROEMPRESA = X.NROEMPRESA) CNPJ_EMP,
       TO_CHAR(X.DTAEMISSAO, 'DD/MM/YYYY') AS DTAEMISSAO,
       TO_CHAR(X.DTAENTRADA, 'DD/MM/YYYY') AS DTAENTRADA,
       TO_CHAR(X.DTAENTRADA, 'MM')         AS MES_DTAENTRADA,
       TO_CHAR(X.DTAENTRADA, 'YYYY')       AS ANO_DTAENTRADA,
       TO_CHAR(B.DTAVENCTO,  'DD/MM/YYYY') AS DTAVENCIMENTO,
       TO_CHAR(B.DTAVENCTO,  'MM')         AS MES_DTAVENCIMENTO,
       TO_CHAR(B.DTAVENCTO,  'YYYY')       AS ANO_DTAVENCIMENTO,
       TO_CHAR(X.DTAALTERACAO, 'DD/MM/YYYY') AS DTAALTERACAO,
       NRONOTA,
       A.NOMERAZAO AS NOMERAZAO,
       LPAD(A.NROCGCCPF, 12, 0) || LPAD(A.DIGCGCCPF, 2, 0) AS CNPJ,
       COD.COD_NAT_REND AS COD_NAT_REND,
       X.CODHISTORICO AS NATUREZA,
       X.VALOR AS VALOR_NF_COMISSAO,
       B.VALOR AS VALOR_PARC,
       D.VALOR AS IRRF,
       CASE WHEN D.VALOR IS NOT NULL THEN X.ALIQIR ELSE NULL END AS ALIQIR,
       CASE WHEN D.VALOR IS NOT NULL THEN TO_CHAR(X.DTAVENCTOIR, 'DD/MM/YYYY') ELSE NULL END AS VENC_IRRF,
       CASE WHEN D.VALOR IS NOT NULL THEN X.CODRECDARFIRRF ELSE NULL END AS CODIGO_IR,
       ROUND((B.VALOR / 100 * X.ALIQPIS), 2) AS VLRPIS,
       TO_CHAR(X.ALIQPIS, 'FM999G999G990D90', 'NLS_NUMERIC_CHARACTERS='',.''') AS ALIQPIS,
       ROUND((B.VALOR / 100 * X.ALIQCOFINS), 2) AS VLRCOFINS,
       TO_CHAR(X.ALIQCOFINS, 'FM999G999G990D90', 'NLS_NUMERIC_CHARACTERS='',.''') AS ALIQCOFINS,
       ROUND((B.VALOR / 100 * X.ALIQCSSLL), 2) AS VLRCSSLL,
       TO_CHAR(X.ALIQCSSLL, 'FM999G999G990D90', 'NLS_NUMERIC_CHARACTERS='',.''') AS ALIQCSSLL,
       C.VALOR AS TOTAL_PCC,
       TO_CHAR(C.DTAVENCIMENTO, 'DD/MM/YYYY') AS VENC_PCC,
       COALESCE(X.CODRECDARFPISRET, X.CODRECDARFPISRET, X.CODRECDARFCOFINSRET, X.CODRECDARFCSLLRET) AS COD_PCC,
       B.NROPARCELA AS NROPARCELA

   FROM CONSINCO.OR_NFDESPESA X
   INNER JOIN CONSINCO.GE_PESSOA A ON A.SEQPESSOA = X.SEQPESSOA
   INNER JOIN CONSINCO.OR_NFVENCIMENTO B ON X.SEQNOTA = B.SEQNOTA AND X.NROEMPRESA = B.NROEMPRESA
    LEFT JOIN CONSINCO.OR_NFDESPIMPOSTOS C ON C.SEQNOTA = X.SEQNOTA AND C.NROPARCELA = B.NROPARCELA AND C.CODESPECIEIMP = 'PCCNF'
    LEFT JOIN CONSINCO.OR_NFDESPIMPOSTOS D ON D.SEQNOTA = X.SEQNOTA AND D.NROPARCELA = B.NROPARCELA AND D.CODESPECIEIMP = 'IRRFNF'
    LEFT JOIN CONSINCO.NAGT_REINF_COD_NAT_REND COD ON COD.CODHISTORICO = X.CODHISTORICO -- De/Para Codigo Nat Rendimento

 WHERE 1=1
   AND COALESCE(ALIQPIS, ALIQCOFINS, ALIQCSSLL, X.ALIQIR) IS NOT NULL

 ORDER BY 6,1
;
