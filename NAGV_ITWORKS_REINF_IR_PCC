-- View na CONSINCO

SELECT X.NROEMPRESA,
       X.CNPJ_EMP,
       X.DTAEMISSAO,
       X.DTAENTRADA,
       X.DTAVENCIMENTO,
       X.NRONOTA,
       X.NOMERAZAO,
       X.COD_NAT_REND,
       X.VALOR_NF_COMISSAO,
       X.VALOR_PARC,
       X.IRRF,
       X.ALIQIR,
       X.VENC_IRRF,
       X.CODIGO_IR,
       X.VLRPIS,
       X.ALIQPIS,
       X.VLRCOFINS,
       X.ALIQCOFINS,
       X.VLRCSSLL,
       X.ALIQCSSLL,
       X.TOTAL_PCC,
       X.VENC_PCC,
       X.COD_PCC FROM NAGV_ITWORKS_REINF_IR_PCC X

 WHERE TO_DATE(DTAENTRADA, 'DD/MM/YYYY') BETWEEN :DT1 AND :DT2 
   AND LPAD(NROEMPRESA,3,0) IN (#LS1) 
   AND LPAD(NROEMPRESA,3,0) IN (SELECT NROEMPRESA FROM CONSINCO.GE_EMPRESA X WHERE X.MATRIZ IN (#LS2))
   
ORDER BY 1,4

-- Por Vencimento - Com Totais

SELECT * FROM ( 

SELECT X.NROEMPRESA LOJA,
       X.CNPJ_EMP CNPJ,
       X.DTAENTRADA,
       X.DTAVENCIMENTO,
       X.NRONOTA NF,
       X.NOMERAZAO RAZAO,
       X.COD_NAT_REND COD_REND,
       TO_CHAR(X.VALOR_NF_COMISSAO, 'FM999G999G990D90', 'NLS_NUMERIC_CHARACTERS='',.''') VALOR_NF,
       TO_CHAR(X.VALOR_PARC, 'FM999G999G990D90', 'NLS_NUMERIC_CHARACTERS='',.''') VALOR_PARC,
       TO_CHAR(CASE WHEN TO_DATE(VENC_IRRF, 'DD/MM/YYYY') BETWEEN :DT1 AND :DT2 THEN X.IRRF       ELSE NULL END, 'FM999G999G990D90', 'NLS_NUMERIC_CHARACTERS='',.''') IR,
       CASE WHEN TO_DATE(VENC_IRRF, 'DD/MM/YYYY') BETWEEN :DT1 AND :DT2 THEN X.VENC_IRRF  ELSE NULL END VENC_IR,
       TO_CHAR(CASE WHEN TO_DATE(VENC_PCC,  'DD/MM/YYYY') BETWEEN :DT1 AND :DT2 THEN X.TOTAL_PCC  ELSE NULL END, 'FM999G999G990D90', 'NLS_NUMERIC_CHARACTERS='',.''') PCC,
       CASE WHEN TO_DATE(VENC_PCC,  'DD/MM/YYYY') BETWEEN :DT1 AND :DT2 THEN X.VENC_PCC   ELSE NULL END VENC_PCC

FROM CONSINCO.NAGV_ITWORKS_REINF_IR_PCC X

 WHERE (TO_DATE(VENC_IRRF, 'DD/MM/YYYY') BETWEEN :DT1 AND :DT2 OR  TO_DATE(VENC_PCC, 'DD/MM/YYYY') BETWEEN :DT1 AND :DT2)
   AND LPAD(NROEMPRESA,3,0) IN (#LS1) 
   AND LPAD(NROEMPRESA,3,0) IN (SELECT NROEMPRESA FROM CONSINCO.GE_EMPRESA X WHERE X.MATRIZ IN (#LS2))
   
ORDER BY 1,4)

  UNION ALL

SELECT NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL FROM DUAL

  UNION ALL

SELECT NULL, NULL, NULL, NULL, NULL, 'TOTAL', NULL, 
       TO_CHAR(SUM(VALOR_NF),   'FM999G999G990D90', 'NLS_NUMERIC_CHARACTERS='',.'''),
       TO_CHAR(SUM(VALOR_PARC), 'FM999G999G990D90', 'NLS_NUMERIC_CHARACTERS='',.'''),
       TO_CHAR(SUM(IR),         'FM999G999G990D90', 'NLS_NUMERIC_CHARACTERS='',.'''), NULL, 
       TO_CHAR(SUM(PCC),        'FM999G999G990D90', 'NLS_NUMERIC_CHARACTERS='',.'''), NULL 
  FROM ( 
SELECT SUM(X.VALOR_NF_COMISSAO) VALOR_NF,
       SUM(X.VALOR_PARC) VALOR_PARC, 
       CASE WHEN TO_DATE(VENC_IRRF, 'DD/MM/YYYY') BETWEEN :DT1 AND :DT2 THEN SUM(X.IRRF)       ELSE NULL END IR, 
       CASE WHEN TO_DATE(VENC_PCC,  'DD/MM/YYYY') BETWEEN :DT1 AND :DT2 THEN SUM(X.TOTAL_PCC)  ELSE NULL END PCC

FROM CONSINCO.NAGV_ITWORKS_REINF_IR_PCC X

 WHERE (TO_DATE(VENC_IRRF, 'DD/MM/YYYY') BETWEEN :DT1 AND :DT2 OR  TO_DATE(VENC_PCC, 'DD/MM/YYYY') BETWEEN :DT1 AND :DT2)
   AND LPAD(NROEMPRESA,3,0) IN (#LS1) 
   AND LPAD(NROEMPRESA,3,0) IN (SELECT NROEMPRESA FROM CONSINCO.GE_EMPRESA X WHERE X.MATRIZ IN (#LS2))
   
   GROUP BY TO_DATE(VENC_IRRF, 'DD/MM/YYYY'), TO_DATE(VENC_PCC,  'DD/MM/YYYY'))
  

-- Old 2

SELECT X.NROEMPRESA LOJA,
       X.CNPJ_EMP CNPJ,
       X.DTAENTRADA,
       X.DTAVENCIMENTO,
       X.NRONOTA NF,
       X.NOMERAZAO RAZAO,
       X.COD_NAT_REND COD_REND,
       TO_CHAR(X.VALOR_NF_COMISSAO, 'FM999G999G990D90', 'NLS_NUMERIC_CHARACTERS='',.''') VALOR_NF,
       TO_CHAR(X.VALOR_PARC, 'FM999G999G990D90', 'NLS_NUMERIC_CHARACTERS='',.''') VALOR_PARC,
       TO_CHAR(CASE WHEN TO_DATE(VENC_IRRF, 'DD/MM/YYYY') BETWEEN :DT1 AND :DT2 THEN X.IRRF       ELSE NULL END, 'FM999G999G990D90', 'NLS_NUMERIC_CHARACTERS='',.''') IR,
       CASE WHEN TO_DATE(VENC_IRRF, 'DD/MM/YYYY') BETWEEN :DT1 AND :DT2 THEN X.VENC_IRRF  ELSE NULL END VENC_IR,
       TO_CHAR(CASE WHEN TO_DATE(VENC_PCC,  'DD/MM/YYYY') BETWEEN :DT1 AND :DT2 THEN X.TOTAL_PCC  ELSE NULL END, 'FM999G999G990D90', 'NLS_NUMERIC_CHARACTERS='',.''') PCC,
       CASE WHEN TO_DATE(VENC_PCC,  'DD/MM/YYYY') BETWEEN :DT1 AND :DT2 THEN X.VENC_PCC   ELSE NULL END VENC_PCC

FROM NAGV_ITWORKS_REINF_IR_PCC X

 WHERE (TO_DATE(VENC_IRRF, 'DD/MM/YYYY') BETWEEN :DT1 AND :DT2 OR  TO_DATE(VENC_PCC, 'DD/MM/YYYY') BETWEEN :DT1 AND :DT2)
   AND LPAD(NROEMPRESA,3,0) IN (#LS1) 
   AND LPAD(NROEMPRESA,3,0) IN (SELECT NROEMPRESA FROM CONSINCO.GE_EMPRESA X WHERE X.MATRIZ IN (#LS2))
   
ORDER BY 1,4

-- Old 1

SELECT X.NROEMPRESA,
       X.CNPJ_EMP,
       X.DTAEMISSAO,
       X.DTAENTRADA,
       X.DTAVENCIMENTO,
       X.NRONOTA,
       X.NOMERAZAO,
       X.COD_NAT_REND,
       X.VALOR_NF_COMISSAO,
       X.VALOR_PARC,
       CASE WHEN TO_DATE(VENC_IRRF, 'DD/MM/YYYY') BETWEEN :DT1 AND :DT2 THEN X.IRRF       ELSE NULL END IRRF,
       CASE WHEN TO_DATE(VENC_IRRF, 'DD/MM/YYYY') BETWEEN :DT1 AND :DT2 THEN X.ALIQIR     ELSE NULL END ALIQIR,
       CASE WHEN TO_DATE(VENC_IRRF, 'DD/MM/YYYY') BETWEEN :DT1 AND :DT2 THEN X.VENC_IRRF  ELSE NULL END VENC_IRRF,
       CASE WHEN TO_DATE(VENC_IRRF, 'DD/MM/YYYY') BETWEEN :DT1 AND :DT2 THEN X.CODIGO_IR  ELSE NULL END CODIGO_IR,
       CASE WHEN TO_DATE(VENC_PCC,  'DD/MM/YYYY') BETWEEN :DT1 AND :DT2 THEN X.VLRPIS     ELSE NULL END VLRPIS,
       CASE WHEN TO_DATE(VENC_PCC,  'DD/MM/YYYY') BETWEEN :DT1 AND :DT2 THEN X.ALIQPIS    ELSE NULL END ALIQPIS,
       CASE WHEN TO_DATE(VENC_PCC,  'DD/MM/YYYY') BETWEEN :DT1 AND :DT2 THEN X.VLRCOFINS  ELSE NULL END VLRCOFINS,
       CASE WHEN TO_DATE(VENC_PCC,  'DD/MM/YYYY') BETWEEN :DT1 AND :DT2 THEN X.ALIQCOFINS ELSE NULL END ALIQCOFINS,
       CASE WHEN TO_DATE(VENC_PCC,  'DD/MM/YYYY') BETWEEN :DT1 AND :DT2 THEN X.VLRCSSLL   ELSE NULL END VLRCSSLL,
       CASE WHEN TO_DATE(VENC_PCC,  'DD/MM/YYYY') BETWEEN :DT1 AND :DT2 THEN X.ALIQCSSLL  ELSE NULL END ALIQCSSLL,
       CASE WHEN TO_DATE(VENC_PCC,  'DD/MM/YYYY') BETWEEN :DT1 AND :DT2 THEN X.TOTAL_PCC  ELSE NULL END TOTAL_PCC,
       CASE WHEN TO_DATE(VENC_PCC,  'DD/MM/YYYY') BETWEEN :DT1 AND :DT2 THEN X.VENC_PCC   ELSE NULL END VENC_PCC,
       CASE WHEN TO_DATE(VENC_PCC,  'DD/MM/YYYY') BETWEEN :DT1 AND :DT2 THEN X.COD_PCC    ELSE NULL END COD_PCC 

FROM NAGV_ITWORKS_REINF_IR_PCC X

 WHERE (TO_DATE(VENC_IRRF, 'DD/MM/YYYY') BETWEEN :DT1 AND :DT2 OR  TO_DATE(VENC_PCC, 'DD/MM/YYYY') BETWEEN :DT1 AND :DT2)
   AND LPAD(NROEMPRESA,3,0) IN (#LS1) 
   AND LPAD(NROEMPRESA,3,0) IN (SELECT NROEMPRESA FROM CONSINCO.GE_EMPRESA X WHERE X.MATRIZ IN (#LS2))
   
ORDER BY 1,4

-- No Banco

CREATE OR REPLACE VIEW CONSINCO.NAGV_ITWORKS_REINF_IR_PCC AS
SELECT /*Para view por Vencto Sem Crtao - Criada por Giuliano  em 28/09/2023 - Solic Aamalia */
       /*REINF R4020 IR e PCC Sobre Notas - Chamado 268634 - Amalia Petronilio | Criado por Giuliano em 04/08/2023*/
       /*Solicitado separacao de IR e PCC por Amalia - 11/09/2023 - PCC sera retornado no segundo select*/
       X.NROEMPRESA, (SELECT LPAD(MA.NROCGC,12,0)||LPAD(MA.DIGCGC,2,0) FROM CONSINCO.MAX_EMPRESA MA WHERE MA.NROEMPRESA = X.NROEMPRESA) CNPJ_EMP,
       TO_CHAR(X.DTAEMISSAO, 'DD/MM/YYYY') AS DTAEMISSAO,
       TO_CHAR(X.DTAENTRADA, 'DD/MM/YYYY') AS DTAENTRADA,
       TO_CHAR(X.DTAENTRADA, 'MM')         AS MES_DTAENTRADA,
       TO_CHAR(X.DTAENTRADA, 'YYYY')       AS ANO_DTAENTRADA,
       TO_CHAR(B.DTAVENCTO,  'DD/MM/YYYY') AS DTAVENCIMENTO,
       TO_CHAR(B.DTAVENCTO,  'MM')         AS MES_DTAVENCIMENTO,
       TO_CHAR(B.DTAVENCTO,  'YYYY')       AS ANO_DTAVENCIMENTO,
       TO_CHAR(X.DTAALTERACAO, 'DD/MM/YYYY') AS DTAALTERACAO,
       NRONOTA,
       A.NOMERAZAO AS NOMERAZAO,
       LPAD(A.NROCGCCPF, 12, 0) || LPAD(A.DIGCGCCPF, 2, 0) AS CNPJ,
       COD.COD_NAT_REND AS COD_NAT_REND,
       X.CODHISTORICO AS NATUREZA,
     --LEAST(X.VALOR,VLRBASEIR) AS VALOR_NF_COMISSAO,
       X.VLRBASEIR AS VALOR_NF_COMISSAO,
       B.VALOR AS VALOR_PARC,
       D.VALOR AS IRRF,
       CASE WHEN D.VALOR IS NOT NULL THEN X.ALIQIR ELSE NULL END AS ALIQIR,
       CASE WHEN D.VALOR IS NOT NULL THEN TO_CHAR(X.DTAVENCTOIR, 'DD/MM/YYYY') ELSE NULL END AS VENC_IRRF,
       CASE WHEN D.VALOR IS NOT NULL THEN X.CODRECDARFIRRF ELSE NULL END AS CODIGO_IR,
       ROUND((B.VALOR / 100 * X.ALIQPIS), 2) AS VLRPIS,
       TO_CHAR(X.ALIQPIS, 'FM999G999G990D90', 'NLS_NUMERIC_CHARACTERS='',.''') AS ALIQPIS,
       ROUND((B.VALOR / 100 * X.ALIQCOFINS), 2) AS VLRCOFINS,
       TO_CHAR(X.ALIQCOFINS, 'FM999G999G990D90', 'NLS_NUMERIC_CHARACTERS='',.''') AS ALIQCOFINS,
       ROUND((B.VALOR / 100 * X.ALIQCSSLL), 2) AS VLRCSSLL,
       TO_CHAR(X.ALIQCSSLL, 'FM999G999G990D90', 'NLS_NUMERIC_CHARACTERS='',.''') AS ALIQCSSLL,
       C.VALOR AS TOTAL_PCC,
       TO_CHAR(C.DTAVENCIMENTO, 'DD/MM/YYYY') AS VENC_PCC,
       COALESCE(X.CODRECDARFPISRET, X.CODRECDARFPISRET, X.CODRECDARFCOFINSRET, X.CODRECDARFCSLLRET) AS COD_PCC,
       B.NROPARCELA AS NROPARCELA

   FROM CONSINCO.OR_NFDESPESA X
   INNER JOIN CONSINCO.GE_PESSOA A ON A.SEQPESSOA = X.SEQPESSOA
   INNER JOIN CONSINCO.OR_NFVENCIMENTO B ON X.SEQNOTA = B.SEQNOTA AND X.NROEMPRESA = B.NROEMPRESA
    LEFT JOIN CONSINCO.OR_NFDESPIMPOSTOS C ON C.SEQNOTA = X.SEQNOTA AND C.NROPARCELA = B.NROPARCELA AND C.CODESPECIEIMP = 'PCCNF'
    LEFT JOIN CONSINCO.OR_NFDESPIMPOSTOS D ON D.SEQNOTA = X.SEQNOTA AND D.NROPARCELA = B.NROPARCELA AND D.CODESPECIEIMP = 'IRRFNF'
    LEFT JOIN CONSINCO.NAGT_REINF_COD_NAT_REND COD ON COD.CODHISTORICO = X.CODHISTORICO -- De/Para Codigo Nat Rendimento

 WHERE 1=1
   AND COALESCE(ALIQPIS, ALIQCOFINS, ALIQCSSLL, X.ALIQIR) IS NOT NULL

 ORDER BY 6,1
;

;
