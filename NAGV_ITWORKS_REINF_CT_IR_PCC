CREATE OR REPLACE VIEW CONSINCO.NAGV_ITWORKS_REINF_CT_IR_PCC AS
SELECT /*Views Unificadas - Criada por Giuliano  em 30/08/2023 - Solic Aamalia */
       /*Retirado Cartoes (coment) - Alt RF nao sera mais necessario*/
       /*REINF R4020 IR e PCC Sobre Notas - Chamado 268634 - Amalia Petronilio | Criado por Giuliano em 04/08/2023*/
       /*Solicitado separacao de IR e PCC por Amalia - 11/09/2023 - PCC sera retornado no segundo select*/
       /*Regra Mes Ano:
               IR = Mes/Ano Entrada
               PCC = Mes/Ano Vencimento
               Cartoes = Mes/Ano Incclusao*/
       X.NROEMPRESA, (SELECT LPAD(MA.NROCGC,12,0)||LPAD(MA.DIGCGC,2,0) FROM CONSINCO.MAX_EMPRESA MA WHERE MA.NROEMPRESA = X.NROEMPRESA) CNPJ_EMP,
       TO_CHAR(X.DTAEMISSAO, 'DD/MM/YYYY') AS DTAEMISSAO,
       TO_CHAR(X.DTAENTRADA, 'DD/MM/YYYY') AS DTAENTRADA,
       TO_CHAR(B.DTAVENCTO,  'DD/MM/YYYY') AS DTAVENCIMENTO,
       TO_CHAR(X.DTAALTERACAO, 'DD/MM/YYYY') AS DTAALTERACAO,
       NRONOTA,
       A.NOMERAZAO AS NOMERAZAO,
       LPAD(A.NROCGCCPF, 12, 0) || LPAD(A.DIGCGCCPF, 2, 0) AS CNPJ,
       COD.COD_NAT_REND AS COD_NAT_REND,
       X.CODHISTORICO AS NATUREZA,
     --LEAST(X.VALOR,VLRBASEIR) AS VALOR_NF_COMISSAO,
       X.VLRBASEIR AS VALOR_NF_COMISSAO,
       B.VALOR AS VALOR_PARC,
       D.VALOR AS IRRF,
       CASE WHEN D.VALOR IS NOT NULL THEN X.ALIQIR ELSE NULL END AS ALIQIR,
       CASE WHEN D.VALOR IS NOT NULL THEN TO_CHAR(X.DTAVENCTOIR, 'DD/MM/YYYY') ELSE NULL END AS VENC_IRRF,
       CASE WHEN D.VALOR IS NOT NULL THEN X.CODRECDARFIRRF ELSE NULL END AS CODIGO_IR,
       NULL AS VLRPIS,
       NULL AS ALIQPIS,
       NULL AS VLRCOFINS,
       NULL AS ALIQCOFINS,
       NULL AS VLRCSSLL,
       NULL AS ALIQCSSLL,
       NULL AS TOTAL_PCC,
       NULL AS VENC_PCC,
       NULL AS COD_PCC,
       B.NROPARCELA AS NROPARCELA, 'IR' TIPO,
       TO_CHAR(X.DTAENTRADA, 'MM')         AS MES,
       TO_CHAR(X.DTAENTRADA, 'YYYY')       AS ANO

   FROM CONSINCO.OR_NFDESPESA X
   INNER JOIN CONSINCO.GE_PESSOA A ON A.SEQPESSOA = X.SEQPESSOA
   INNER JOIN CONSINCO.OR_NFVENCIMENTO B ON X.SEQNOTA = B.SEQNOTA AND X.NROEMPRESA = B.NROEMPRESA
    LEFT JOIN CONSINCO.OR_NFDESPIMPOSTOS C ON C.SEQNOTA = X.SEQNOTA AND C.NROPARCELA = B.NROPARCELA AND C.CODESPECIEIMP = 'PCCNF'
    LEFT JOIN CONSINCO.OR_NFDESPIMPOSTOS D ON D.SEQNOTA = X.SEQNOTA AND D.NROPARCELA = B.NROPARCELA AND D.CODESPECIEIMP = 'IRRFNF'
    LEFT JOIN CONSINCO.NAGT_REINF_COD_NAT_REND COD ON COD.CODHISTORICO = X.CODHISTORICO -- De/Para Codigo Nat Rendimento

 WHERE 1=1
   AND COALESCE(X.ALIQIR, TO_NUMBER(X.CODRECDARFIRRF)) IS NOT NULL

UNION ALL /*PCC*/

SELECT X.NROEMPRESA, (SELECT LPAD(MA.NROCGC,12,0)||LPAD(MA.DIGCGC,2,0) FROM CONSINCO.MAX_EMPRESA MA WHERE MA.NROEMPRESA = X.NROEMPRESA) CNPJ_EMP,
       TO_CHAR(X.DTAEMISSAO, 'DD/MM/YYYY') AS DTAEMISSAO,
       TO_CHAR(X.DTAENTRADA, 'DD/MM/YYYY') AS DTAENTRADA,
       TO_CHAR(B.DTAVENCTO,  'DD/MM/YYYY') AS DTAVENCIMENTO,
       TO_CHAR(X.DTAALTERACAO, 'DD/MM/YYYY') AS DTAALTERACAO,
       NRONOTA,
       A.NOMERAZAO AS NOMERAZAO,
       LPAD(A.NROCGCCPF, 12, 0) || LPAD(A.DIGCGCCPF, 2, 0) AS CNPJ,
       COD.COD_NAT_REND AS COD_NAT_REND,
       X.CODHISTORICO AS NATUREZA,
     --LEAST(X.VALOR,VLRBASEIR) AS VALOR_NF_COMISSAO,
       X.VLRBASEIR AS VALOR_NF_COMISSAO,
       B.VALOR AS VALOR_PARC,
       NULL AS IRRF,
       NULL ALIQIR,
       NULL AS VENC_IRRF,
       NULL AS CODIGO_IR,
       ROUND((B.VALOR / 100 * X.ALIQPIS), 2) AS VLRPIS,
       TO_CHAR(X.ALIQPIS, 'FM999G999G990D90', 'NLS_NUMERIC_CHARACTERS='',.''') AS ALIQPIS,
       ROUND((B.VALOR / 100 * X.ALIQCOFINS), 2) AS VLRCOFINS,
       TO_CHAR(X.ALIQCOFINS, 'FM999G999G990D90', 'NLS_NUMERIC_CHARACTERS='',.''') AS ALIQCOFINS,
       ROUND((B.VALOR / 100 * X.ALIQCSSLL), 2) AS VLRCSSLL,
       TO_CHAR(X.ALIQCSSLL, 'FM999G999G990D90', 'NLS_NUMERIC_CHARACTERS='',.''') AS ALIQCSSLL,
       C.VALOR AS TOTAL_PCC,
       TO_CHAR(C.DTAVENCIMENTO, 'DD/MM/YYYY') AS VENC_PCC,
       COALESCE(X.CODRECDARFPISRET, X.CODRECDARFPISRET, X.CODRECDARFCOFINSRET, X.CODRECDARFCSLLRET) AS COD_PCC,
       B.NROPARCELA AS NROPARCELA, 'PCC' TIPO,
       TO_CHAR(B.DTAVENCTO,  'MM')         AS MES_DTAVENCIMENTO,
       TO_CHAR(B.DTAVENCTO,  'YYYY')       AS ANO_DTAVENCIMENTO

   FROM CONSINCO.OR_NFDESPESA X
   INNER JOIN CONSINCO.GE_PESSOA A ON A.SEQPESSOA = X.SEQPESSOA
   INNER JOIN CONSINCO.OR_NFVENCIMENTO B ON X.SEQNOTA = B.SEQNOTA AND X.NROEMPRESA = B.NROEMPRESA
    LEFT JOIN CONSINCO.OR_NFDESPIMPOSTOS C ON C.SEQNOTA = X.SEQNOTA AND C.NROPARCELA = B.NROPARCELA AND C.CODESPECIEIMP = 'PCCNF'
    LEFT JOIN CONSINCO.OR_NFDESPIMPOSTOS D ON D.SEQNOTA = X.SEQNOTA AND D.NROPARCELA = B.NROPARCELA AND D.CODESPECIEIMP = 'IRRFNF'
    LEFT JOIN CONSINCO.NAGT_REINF_COD_NAT_REND COD ON COD.CODHISTORICO = X.CODHISTORICO -- De/Para Codigo Nat Rendimento

 WHERE 1=1
   AND COALESCE(ALIQPIS, ALIQCOFINS, ALIQCSSLL) IS NOT NULL

/*  Retirado Cartoes - Alteracao da RF nao sera mais necessario*/
/*
UNION ALL

SELECT --Adm. de Cart√µes - Chamado 268630 - Amalia Petronilio | Criado por Giuliano em 07/08/2023
       X.NROEMPRESA, (SELECT LPAD(MA.NROCGC,12,0)||LPAD(MA.DIGCGC,2,0) FROM CONSINCO.MAX_EMPRESA MA WHERE MA.NROEMPRESA = X.NROEMPRESA) CNPJ_EMP,
       TO_CHAR(X.DTAEMISSAO, 'DD/MM/YYYY')  AS DTAEMISSAO,
       TO_CHAR(X.DTAINCLUSAO, 'DD/MM/YYYY') AS DTAENTRADA,
       NULL AS DTAVENCIMENTO,
       TO_CHAR(X.DTAALTERACAO,'DD/MM/YYYY') AS DTAALTERACAO,
       NULL AS NRONOTA,
       B.NOMERAZAO AS NOMERAZAO,
       LPAD(B.NROCGCCPF, 12, 0) || LPAD(B.DIGCGCCPF, 2, 0) AS CNPJ,
       20007 AS COD_NAT_REND,
       NULL AS NATUREZA,
       SUM(X.VLRADMINISTRACAO) AS VALOR_NF,
       NULL AS VALOR_PARC,
       NULL AS IRRF,
       NULL AS ALIQIR,
       NULL AS VENC_IRRF,
       NULL AS CODIGO_IR,
       NULL AS VLRPIS,
       NULL AS ALIQPIS,
       NULL AS VLRCOFINS,
       NULL AS ALIQCOFINS,
       NULL AS VLRCSSLL,
       NULL AS ALIQCSSLL,
       NULL AS TOTAL_PCC,
       NULL AS VENC_PCC,
       NULL AS COD_PCC,
       NULL AS NROPARCELA, 'CARTAO' TIPO,
       TO_CHAR(X.DTAINCLUSAO, 'MM')         AS MES_DTAENTRADA,
       TO_CHAR(X.DTAINCLUSAO, 'YYYY')       AS ANO_DTAENTRADA

   FROM CONSINCO.FI_TITULO X
   INNER JOIN CONSINCO.GE_PESSOA B ON X.SEQPESSOA = B.SEQPESSOA
   INNER JOIN CONSINCO.GE_EMPRESA C ON X.NROEMPRESA = C.NROEMPRESA

 WHERE 1=1
   AND X.CODESPECIE IN ('CARDEB', 'CARTAO', 'TICKET', 'AMERIC')
   AND X.SITUACAO != 'C'
   AND X.SEQPESSOA != 602
 GROUP BY X.NROEMPRESA, TO_CHAR(X.DTAEMISSAO, 'DD/MM/YYYY'),
                        TO_CHAR(X.DTAINCLUSAO, 'DD/MM/YYYY'),
       TO_CHAR(X.DTAINCLUSAO, 'MM'),
       TO_CHAR(X.DTAINCLUSAO, 'YYYY'),
       TO_CHAR(X.DTAALTERACAO, 'DD/MM/YYYY'),
       B.NOMERAZAO , LPAD(B.NROCGCCPF,12,0)||LPAD(B.DIGCGCCPF,2,0)
*/
 ORDER BY 6,1
;
