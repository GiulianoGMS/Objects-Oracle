CREATE OR REPLACE PROCEDURE CONSINCO.NAGP_GERALOTECOMPRA AS
BEGIN
DECLARE
      i INTEGER := 0;
   -- Define como N a geração no dia da semana dos lotes que existem configuracao na tabela de controle
      BEGIN
        FOR g IN (SELECT D.SEQLOTEMODELO, D.HORAMIN FROM CONSINCO.NAGV_BUSCADTAPEDIDO D
                   WHERE EXISTS (SELECT SEQGERCOMPRA FROM CONSINCO.MAC_GERCOMPRA Z 
                                  WHERE Z.SEQGERCOMPRA = D.SEQLOTEMODELO
                                    AND(Z.AGENDADOMINGO = 'S' OR
                                        Z.AGENDASEGUNDA = 'S' OR
                                        Z.AGENDATERCA   = 'S' OR
                                        Z.AGENDAQUARTA  = 'S' OR
                                        Z.AGENDAQUINTA  = 'S' OR
                                        Z.AGENDASEXTA   = 'S' OR
                                        Z.AGENDASABADO  = 'S')))
                 
    LOOP
      BEGIN
        UPDATE CONSINCO.MAC_GERCOMPRA X SET X.AGENDADOMINGO = 'N',
                                            X.AGENDASEGUNDA = 'N',
                                            X.AGENDATERCA   = 'N',
                                            X.AGENDAQUARTA  = 'N',
                                            X.AGENDAQUINTA  = 'N',
                                            X.AGENDASEXTA   = 'N',
                                            X.AGENDASABADO  = 'N'
                                      WHERE X.SEQGERCOMPRA = G.SEQLOTEMODELO
                                        AND X.TIPOLOTE = 'M';
                                      
      COMMIT;
     END;
    END LOOP;
   -- Busca se existe lote configurado com data/hora e min igual a data atual para geração do lote
        FOR t IN (SELECT SEQLOTEMODELO, C.COMPRADOR, G.DESCRITIVO, NOMERAZAO FORNECEDOR,
                    DATA_VALIDA, HORAMIN, NVL(A.EMAIL||CASE WHEN E.EMAIL IS NULL THEN NULL ELSE ';' END||E.EMAIL, 'X') EMAIL
               FROM CONSINCO.NAGV_BUSCADTAPEDIDO D LEFT JOIN CONSINCO.MAC_GERCOMPRA G ON G.SEQGERCOMPRA = D.SEQLOTEMODELO AND G.TIPOLOTE = 'M'
                                                  INNER JOIN CONSINCO.GE_PESSOA     P ON P.SEQPESSOA    = G.SEQFORNECPRINCIPAL
                                                  INNER JOIN CONSINCO.MAX_COMPRADOR C ON C.SEQCOMPRADOR = G.SEQCOMPRADOR
                                                   LEFT JOIN CONSINCO.NAGT_EMAILCOMPRADORES A ON A.COMPRADOR = C.APELIDO
                                                   LEFT JOIN CONSINCO.NAGT_EMAILCOMPRADORES E ON E.COMPRADOR = D.ASSISTENTE AND E.COMPRADOR != A.COMPRADOR

                   WHERE 1=1
                     AND SYSDATE >= TO_DATE(TO_CHAR(D.DATA_VALIDA, 'DD/MM/YYYY')||' '||D.HORAMIN, 'DD/MM/YYYY HH24:MI')
                     AND NOT EXISTS (SELECT 1 FROM CONSINCO.MAC_GERCOMPRA Y WHERE Y.SEQGERMODELOCOMPRA = D.SEQLOTEMODELO AND TRUNC(DTAHORINCLUSAO) = TRUNC(SYSDATE))
                   ORDER BY HORAMIN ASC)

    LOOP
      BEGIN
   -- Cria o lote
      i := i+1;
      CONSINCO.NAGP_spMac_GeraLoteCompra(TRUNC(SYSDATE), 'N',t.SEQLOTEMODELO);
   -- Insere log na tabela de logs caso a geração seja realizada com sucesso
      INSERT INTO CONSINCO.NAGT_LOGGERALOTEAUTO VALUES (T.SEQLOTEMODELO, SYSDATE, 'JOBGERALOTE', 'GERADO', 'COMPRAS');
      IF i = 1 THEN COMMIT;
      i := 0;
   -- Envia email quando o lote for criado com sucesso
      CONSINCO.SP_ENVIA_EMAIL(CONSINCO.C5_TP_PARAM_SMTP(1),
                            'giuliano.gomes@nagumo.com.br;ricardo.santana@nagumo.com.br;marcel.cipolla@nagumo.com.br'
                            ||T.EMAIL||';',                                                                                                             
                            'Lote de Compras Gerado com Sucesso! Fornecedor: '|| T.FORNECEDOR,                                 
                          '<HTML>
                            <strong>Informativo:</strong>                                 <br/>
                            <p>O Lote Modelo: '||T.SEQLOTEMODELO||' para o Fornecedor: '||T.FORNECEDOR||' 
                            <p>Foi gerado com SUCESSO! Programação: '||TO_CHAR(T.DATA_VALIDA, 'DD/MM/YYYY')||' às '||T.HORAMIN||' hrs
                            <p>Descrição do Lote: '||T.DESCRITIVO||'
                            <p style="color:red;">Para cancelar ou alterar a programação deste lote, entre em contato com o Departamento de TI<br/>
                            <p style="color:darkblue;"> Este é um e-mail automático - Não responda </p>
                            <p style="color:gray;"> TI - ERP | Sistemas<p>
                            <p style="font-size: 12px; color:lightgray;">Desenvolvido por Giuliano | Cipolla - TI | Param.: Ricardo Santana</p>
                          </HTML>', 'N');  -- MENSAGEM
      END IF;
      
      EXCEPTION
        
        WHEN OTHERS THEN
   -- Insere logs na tabela de logs caso conste erro
         INSERT INTO CONSINCO.NAGT_LOGGERALOTEAUTO VALUES (T.SEQLOTEMODELO, SYSDATE, 'JOBGERALOTE', 'ERRO', 'COMPRAS');
         COMMIT;
   -- Envia e-mail quando pedido apresentar erro na geração
         CONSINCO.SP_ENVIA_EMAIL(CONSINCO.C5_TP_PARAM_SMTP(1),
                            'giuliano.gomes@nagumo.com.br;ricardo.santana@nagumo.com.br',                         -- DESTINÁRIO                                                   
                            'Erro na geração de lote de compras - Lote Modelo: '              || T.SEQLOTEMODELO, -- ASSUNTO                                   
                            'Lote Modelo: '|| T.SEQLOTEMODELO                                 ||CHR(10)||
                            'Data:   '     || TO_CHAR(SYSDATE, 'DD/MM/YYYY HH24:Mi:ss')       ||CHR(10)||
                            '* Erro na geração de lote de compras pelo Job *', 'N');  -- MENSAGEM
      COMMIT;
      END;
    END LOOP;
    COMMIT;
  END;
END;
