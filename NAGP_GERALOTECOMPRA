CREATE OR REPLACE PROCEDURE NAGP_GERALOTECOMPRA AS
BEGIN
DECLARE
      i INTEGER := 0;
      v_NroLote NUMBER;
      v_DtaInclusao DATE;
   -- Define como N a geração no dia da semana dos lotes que existem configuracao na tabela de controle
      BEGIN
        FOR g IN (SELECT D.SEQLOTEMODELO, D.HORAMIN FROM CONSINCO.NAGV_BUSCADTAPEDIDO D
                   WHERE EXISTS (SELECT SEQGERCOMPRA FROM CONSINCO.MAC_GERCOMPRA Z 
                                  WHERE Z.SEQGERCOMPRA = D.SEQLOTEMODELO
                                    AND(Z.AGENDADOMINGO = 'S' OR
                                        Z.AGENDASEGUNDA = 'S' OR
                                        Z.AGENDATERCA   = 'S' OR
                                        Z.AGENDAQUARTA  = 'S' OR
                                        Z.AGENDAQUINTA  = 'S' OR
                                        Z.AGENDASEXTA   = 'S' OR
                                        Z.AGENDASABADO  = 'S')))
                 
    LOOP
      BEGIN
        UPDATE CONSINCO.MAC_GERCOMPRA X SET X.AGENDADOMINGO = 'N',
                                            X.AGENDASEGUNDA = 'N',
                                            X.AGENDATERCA   = 'N',
                                            X.AGENDAQUARTA  = 'N',
                                            X.AGENDAQUINTA  = 'N',
                                            X.AGENDASEXTA   = 'N',
                                            X.AGENDASABADO  = 'N'
                                      WHERE X.SEQGERCOMPRA = G.SEQLOTEMODELO
                                        AND X.TIPOLOTE = 'M';
                                      
      COMMIT;
     END;
    END LOOP;
   -- Busca se existe lote configurado com data/hora e min igual a data atual para geração do lote
        FOR t IN (SELECT SEQLOTEMODELO, C.COMPRADOR, G.DESCRITIVO, NOMERAZAO FORNECEDOR,
                    DATA_VALIDA, HORAMIN, NVL(A.EMAIL||CASE WHEN E.EMAIL IS NULL OR A.EMAIL IS NULL THEN NULL ELSE ';' END||E.EMAIL, 'X') EMAIL, INITCAP(NVL(U.NOME, C.COMPRADOR)) NOME, FORMACALC
               FROM CONSINCO.NAGV_BUSCADTAPEDIDO D LEFT JOIN CONSINCO.MAC_GERCOMPRA G ON G.SEQGERCOMPRA = D.SEQLOTEMODELO AND G.TIPOLOTE = 'M'
                                                  INNER JOIN CONSINCO.GE_PESSOA     P ON P.SEQPESSOA    = G.SEQFORNECPRINCIPAL
                                                  INNER JOIN CONSINCO.MAX_COMPRADOR C ON C.SEQCOMPRADOR = G.SEQCOMPRADOR
                                                   LEFT JOIN CONSINCO.NAGT_EMAILCOMPRADORES A ON UPPER(A.COMPRADOR) = C.APELIDO
                                                   LEFT JOIN CONSINCO.NAGT_EMAILCOMPRADORES E ON UPPER(E.COMPRADOR) = D.ASSISTENTE --AND E.EMAIL != A.EMAIL
                                                   LEFT JOIN CONSINCO.GE_USUARIO            U ON U.CODUSUARIO = D.ASSISTENTE

                   WHERE 1=1 
                     AND SYSDATE >= TO_DATE(TO_CHAR(D.DATA_VALIDA, 'DD/MM/YYYY')||' '||D.HORAMIN, 'DD/MM/YYYY HH24:MI')
                     AND NOT EXISTS (SELECT 1 FROM CONSINCO.MAC_GERCOMPRA Y WHERE Y.SEQGERMODELOCOMPRA = D.SEQLOTEMODELO AND TRUNC(DTAHORINCLUSAO) = TRUNC(SYSDATE) AND SITUACAOLOTE != 'C') 
                     AND G.SITUACAOLOTE != 'C'
                   ORDER BY HORAMIN ASC)

    LOOP
      BEGIN
   -- Cria o lote
      i := i+1;
      CONSINCO.NAGP_spMac_GeraLoteCompra(TRUNC(SYSDATE), 'N',t.SEQLOTEMODELO);
   -- Insere log na tabela de logs caso a geração seja realizada com sucesso
      INSERT INTO CONSINCO.NAGT_LOGGERALOTEAUTO VALUES (T.SEQLOTEMODELO, SYSDATE, 'JOBGERALOTE', 'GERADO', 'COMPRAS');
      IF i = 1 THEN COMMIT;
      i := 0;
      SELECT MAX(SEQGERCOMPRA), MAX(MC.DTAHORINCLUSAO)
        INTO v_NroLote, v_DtaInclusao
        FROM CONSINCO.MAC_GERCOMPRA MC WHERE MC.SEQGERMODELOCOMPRA = T.SEQLOTEMODELO AND MC.SITUACAOLOTE != 'C';
   -- Recalcula se estiver parametrizado
      IF t.FORMACALC IS NOT NULL AND v_DtaInclusao >= TRUNC(SYSDATE) THEN
        BEGIN
          NAGPKG_SUGESTAO_COMPRA.NAGP_ATUALIZA_SUGESTAO(v_NroLote, T.FORMACALC);
          END;
      END IF;
   -- Envia email quando o lote for criado com sucesso
      IF v_DtaInclusao >= TRUNC(SYSDATE) THEN
      CONSINCO.SP_ENVIA_EMAIL(CONSINCO.C5_TP_PARAM_SMTP(1),
                            'giuliano.gomes@nagumo.com.br;ricardo.santana@nagumo.com.br;marcel.cipolla@nagumo.com.br;'
                            ||T.EMAIL||';',                                                                                                          
                            'Lote de Compras Gerado com Sucesso! Fornecedor: '|| T.FORNECEDOR,                                 
                          '<HTML>
                            <strong>Informativo:</strong>  <br/>
                            <p>O Lote: '||v_NroLote||' para o Fornecedor: '||T.FORNECEDOR||' 
                            <p>Comprador(a)/Assistente: '||T.NOME||'
                            <p>Foi gerado com SUCESSO!
                            <p>Descrição do Lote: '||T.DESCRITIVO||'
                            <p style="color:red;">Para cancelar ou alterar a programação deste lote, entre em contato com o Departamento de TI<br/>
                            <p style="font-family: Arial, Helvetica, Sans Serif; font-size: 12px;color:darkblue;"> Este é um e-mail automático - Não responda </p>
                          </HTML>'||
                          -- Começa a Assinatura
                          '<html><head>
    <meta charset="UTF-8">
    <title>Supermercados Nagumo</title>

  <body>
    <table width="765" border="0" cellspacing="0" cellpadding="0">
      <tbody>
        <tr>
          <td colspan="3" style="
              font-family: Arial, Helvetica, Sans Serif;
              font-size: 14px;
              color: #707070;
            ">
          </td>
        </tr>
        <tr>
          
          
          
        </tr>
        <tr>
          <td width="360">
            <a href="https://www.nagumo.com.br" target="_blank" title="Supermercados Nagumo">
              <img src="https://institucional.nagumo.com.br/assinatura/nagumo_2025.png" width="355" height="189" alt="Supermercados Nagumo">
            </a>
          </td>
          <td width="33" align="center">
            <div style="
                width: 1px;
                height: 220px;
                background-color: #dedede;
                margin: 0 auto;
                display: block;
              "></div>
          </td>
          <td width="372">
            <font>
              <p style="
                  font-family: Arial, Helvetica, Sans Serif;
                  font-size: 14px;
                  color: #003865;
                  font-weight: bold;
                  margin-bottom: 0px;
                ">
                E-mail Automático
              </p>

              <p style="
                  font-family: Arial, Helvetica, Sans Serif;
                  font-size: 13px;
                  color: #d50037;
                  font-weight: bold;
                  margin: 0px;
                ">
                Nagumo - TI | ERP | Sistemas
              </p>


              <p style="
                  font-family: Arial, Helvetica, Sans Serif;
                  font-size: 14px;
                  color: #2679ba;
                  font-weight: bold;
                  margin: 0px;
                ">sistemas.ti@nagumo.com.br
              </p>

              <p></p>
              
              <p style="font-family: Arial, Helvetica, Sans Serif; font-size: 12px; color:lightgray; font-weight: bold; margin: 0px;">
                                    Desenvolvido por Giuliano Gomes | Marcel Cipolla
                                    Parametrizações - Ricardo Santana
                                  </p>
            </font>

            <p></p>

            <table width="342" border="0" cellspacing="0" cellpadding="0">
              <tbody>
                <tr>
                  <td colspan="9">
                    <img src="https://institucional.nagumo.com.br/assinatura/estamos-on_2025.png" width="113" height="28" alt="Facebook">
                  </td>
                </tr>
                <tr>
                  <td width="34">
                    <a href="https://www.linkedin.com/company/supermercadosnagumo/" target="_blank" title="LinkedIn">
                      <img src="https://institucional.nagumo.com.br/assinatura/linkedin_2025.png" width="32" height="32" alt="LinkedIn">
                    </a>
                  </td>
                  <td width="34">
                    <a href="https://www.youtube.com/channel/UCw84_S2C9HfcogPjrvko1nw" target="_blank" title="Youtube">
                      <img src="https://institucional.nagumo.com.br/assinatura/youtube_2025.png" width="32" height="32" alt="Youtube">
                    </a>
                  </td>
                  <td width="34">
                    <a href="https://blog.nagumo.com.br" target="_blank" title="Blog">
                      <img src="https://institucional.nagumo.com.br/assinatura/blog_2025.png" width="32" height="32" alt="Blog">
                    </a>
                  </td>
                  <td width="34">
                    <a href="https://www.facebook.com/supermercadosnagumo" target="_blank" title="Facebook">
                      <img src="https://institucional.nagumo.com.br/assinatura/facebook_2025.png" width="32" height="32" alt="Facebook">
                    </a>
                  </td>
                  <td width="34">
                    <a href="https://www.instagram.com/supermercados_nagumo/" target="_blank" title="Instagram">
                      <img src="https://institucional.nagumo.com.br/assinatura/instagram_2025.png" width="32" height="32" alt="Instagram">
                    </a>
                  </td>
                  <td width="34">
                    <a href="https://www.tiktok.com/@supermercadosnagumo" target="_blank" title="TikTok">
                      <img src="https://institucional.nagumo.com.br/assinatura/tiktok_2025.png" width="32" height="32" alt="Tiktok">
                    </a>
                  </td>
                  <td width="34">
                    <a href="https://api.whatsapp.com/send?phone=5511947246075" target="_blank" title="WhatsApp">
                      <img src="https://institucional.nagumo.com.br/assinatura/whatsapp_2025.png" width="32" height="32" alt="WhatsApp">
                    </a>
                  </td>
                  <td width="104">
                    <a href="https://www.threads.net/@supermercados_nagumo" target="_blank" title="Threads">
                      <img src="https://institucional.nagumo.com.br/assinatura/treads_2025.png" width="32" height="32" alt="Threads">
                    </a>
                  </td>
                </tr>
              </tbody>
            </table>
          </td>
        </tr>
        <tr>
          
          
          
        </tr>
        <tr>
          
          
          
        </tr>
        <tr>
          <td colspan="3">
            <p style="
                font-family: Arial, Helvetica, Sans Serif;
                font-size: 12px;
                color: #5d5d5d;
                font-weight: bold;
              ">
              PRIVACIDADE E CONFIDENCIALIDADE
            </p>

            <p style="
                font-family: Arial, Helvetica, Sans Serif;
                font-size: 12px;
                color: #5d5d5d;
              ">
              Esta mensagem e seu conteúdo tem caráter absolutamente privativo e
              confidencial entre o remetente e o real destinatário, protegida
              pelas legislações brasileira e internacional. Se você recebeu
              indevida ou equivocadamente esta mensagem, pedimos desculpas pelo
              inconveniente e solicitamos que seja deletado imediatamente a
              mensagem e seus anexos da sua caixa postal, bem como da sua
              lixeira, construindo potencial infração o armazenamento indevido
              de qualquer das informações aqui veiculadas.
            </p>
          </td>
        </tr>
      </tbody>
    </table>
  

</body></html>', 'N');  -- MENSAGEM
      END IF;
      END IF;
      
      EXCEPTION
        
        WHEN OTHERS THEN
   -- Insere logs na tabela de logs caso conste erro
         INSERT INTO CONSINCO.NAGT_LOGGERALOTEAUTO VALUES (T.SEQLOTEMODELO, SYSDATE, 'JOBGERALOTE', 'ERRO', 'COMPRAS');
         COMMIT;
   -- Envia e-mail quando pedido apresentar erro na geração
         CONSINCO.SP_ENVIA_EMAIL(CONSINCO.C5_TP_PARAM_SMTP(1),
                            'email',                         -- DESTINÁRIO                                                   
                            'Erro na geração de lote de compras - Lote Modelo: '              || T.SEQLOTEMODELO, -- ASSUNTO                                   
                            'Lote Modelo: '|| T.SEQLOTEMODELO                                 ||CHR(10)||
                            'Data:   '     || TO_CHAR(SYSDATE, 'DD/MM/YYYY HH24:Mi:ss')       ||CHR(10)||
                            '* Erro na geração de lote de compras pelo Job * - Erro: '||SQLERRM, 'N');  -- MENSAGEM
      COMMIT;
      END;
    END LOOP;
    COMMIT;
  END;
END;
