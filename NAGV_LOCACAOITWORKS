CREATE OR REPLACE VIEW CONSINCO.NAGV_LOCACAOITWORKS AS
(
SELECT (SELECT LPAD(GE.NROCGC,12,0)||LPAD(GE.DIGCGC,2,0)       FROM CONSINCO.GE_EMPRESA GE WHERE SEQPESSOA = O.NROEMPRESA) CAIXAENTRADA,
       O.DTAENTRADA DTA_LANCTO,
       (SELECT LPAD(G.NROCGCCPF,12,0)||LPAD(G.DIGCGCCPF,2,0)   FROM CONSINCO.GE_PESSOA G   WHERE SEQPESSOA = O.SEQPESSOA) CNPJCPFEMITENTE,
       CASE WHEN X.CODPRODUTO IS NULL THEN '872232' ELSE X.CODPRODUTO END CODPRODUTO,
       SUM(O.VALOR) VLR_TOTAL,
       --TO_DATE('01/01/0001 00:00:00', 'DD/MM/YYYY HH24:MI:SS')  DTA_ALTERACAO
     -- Agrupa as NFs por Nro Requisição para pegar a data mais recente de alteração dentre as
     -- notas no grupo de requisições e retorna a data mais recente para todas elas
       --(SELECT MAX(X.DTAALTERACAO) FROM CONSINCO.OR_NFDESPESA X WHERE X.REQUISICOES = O.REQUISICOES) DTA_ALTERACAO
     -- Ticket 205255 | Solic Silene | Alterado por Giuliano 27/04/2023
       (SELECT MAX(X.DTAALTERACAO) FROM CONSINCO.OR_NFDESPESA X WHERE X.SEQPESSOA = O.SEQPESSOA AND X.DTAENTRADA = O.DTAENTRADA) DTA_ALTERACAO

FROM CONSINCO.OR_NFDESPESA O LEFT JOIN CONSINCO.RF_PARAMNATNFDESP X ON X.CODHISTORICO = O.CODHISTORICO
   WHERE O.CODHISTORICO IN (266,1065,5707)

   GROUP BY
   O.NROEMPRESA, O.SEQPESSOA,
   DTAENTRADA, CODPRODUTO

)
;
