CREATE OR REPLACE VIEW CONSINCO.NAGV_INCONSIST_LIMITECOMP AS

SELECT DISTINCT X.NUMERONF, 
                X.NROEMPRESA,
               'Comprador não possúi limite disponível. Valor dos Itens sem Pedidos: R$ '||
                TO_CHAR(
                 SUM(Y.VLRITEM) --+ SUM(Y.VLRIPI) + SUM(Y.VLRICMS) + SUM(Y.VLRDESPTRIBUTITEM) + SUM(Y.VLRPIS) + SUM(Y.VLRCOFINS)
               - SUM(Y.VLRDESCITEM) - SUM(NVL(Y.VLRDESCFINANCEIRO,0)),
               'FM999G999G999D90', 'NLS_NUMERIC_CHARACTERS='',.''')||' Valor Disponível: R$ '||
                TO_CHAR(VLRDISPONIVEL,'FM999G999G999D90', 'NLS_NUMERIC_CHARACTERS='',.''') INCONSISTENCIA,
                --'Não existe saldo disponível para o comprador para recebimento sem pedido. Entre em contato com o Departamento Comercial'
                C.COMPRADOR, X.DTAENTRADA
                 
  FROM CONSINCO.MLF_AUXNOTAFISCAL X INNER JOIN CONSINCO.MLF_AUXNFITEM Y ON Y.SEQAUXNOTAFISCAL = X.SEQAUXNOTAFISCAL
                                    INNER JOIN CONSINCO.MAP_PRODUTO   P ON P.SEQPRODUTO = Y.SEQPRODUTO
                                    INNER JOIN CONSINCO.MAP_FAMDIVISAO F ON F.SEQFAMILIA = P.SEQFAMILIA
                                    INNER JOIN CONSINCO.NAGV_LIMITECOMPRADOR NV ON NV.SEQCOMPRADOR = F.SEQCOMPRADOR
                                    INNER JOIN CONSINCO.MLF_AUXNFINCONSISTENCIA A ON A.SEQAUXNOTAFISCAL = X.SEQAUXNOTAFISCAL AND A.SEQAUXNFITEM = Y.SEQAUXNFITEM
                                    INNER JOIN CONSINCO.MAX_COMPRADOR C ON NV.SEQCOMPRADOR = C.SEQCOMPRADOR
                           
 WHERE A.CODINCONSIST IN (7) 
   AND A.AUTORIZADA = 'N'         
   AND A.TIPOINCONSIST = 'P' 
   AND X.DTAENTRADA > SYSDATE - 100
 GROUP BY X.SEQAUXNOTAFISCAL, X.NUMERONF, X.NROEMPRESA, VLRDISPONIVEL, COMPRADOR, X.DTAENTRADA

HAVING SUM(Y.VLRITEM) 
     - SUM(Y.VLRDESCITEM) > VLRDISPONIVEL
     
     ORDER BY X.NROEMPRESA
